name: OS X

on:
  push:
    branches: [ master ]
    tags: [ "*" ]
  pull_request:
    branches: [ master ]

jobs:
  osx_wheel:
    runs-on: macos-10.15

    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: install homebrew deps
        run: brew install fftw hdf5 ccache boost-python3 cfitsio wcslib wget

      - name: pip install numpy
        run: pip3 install numpy

      - name:  get SOFA
        run: wget http://www.iausofa.org/2015_0209_F/sofa_f-20150209_a.tar.gz -O sofa.tgz

      - name:  get WSRT measures
        run: wget ftp://ftp.astron.nl/outgoing/Measures/WSRT_Measures.ztar -O WSRT_Measures.ztar


      - name: build sofa
        run: cd sofa/20150209_a/f77/src/ && make && make test && cd ../../../../

      - name: extract archives
        run: |
          mkdir -p build
          cd build
          tar zxvf ../sofa.tgz
          tar zxvf ../WSRT_Measures.ztar


      - name: configure
        run: CXX="ccache $CXX" cmake .. \
              -DBUILD_TESTING=ON \
              -DUSE_OPENMP=OFF \
              -DUSE_HDF5=ON \
              -DBUILD_PYTHON=OFF \
              -DBUILD_PYTHON3=ON \
              -DBoost_NO_BOOST_CMAKE=True \
              -DCMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH} \
              -DDATA_DIR=$PWD \
              -DSOFA_ROOT_DIR=$PWD \
              -DCMAKE_INSTALL_PREFIX=${TRAVIS_BUILD_DIR}/installed

      - name: build
        run: make -j4

      - name: run tests  
        run: CTEST_OUTPUT_ON_FAILURE=1 ctest -E tConvert
    
      - name: install
        run: make install
