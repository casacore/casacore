\chapter{Code development}
\label{Code development}
\index{code!development}
\index{coding|see{code, development}}
\index{programming|see{code, development}}

Information specifically for programmers who are developing code in \aipspp\ 
\footnote{Last change:
$ $Id$ $}.

% ----------------------------------------------------------------------------

\section{Overview of code development}
\label{Overview of code development}
\index{overview!code development}
\index{code!development!overview}

This section runs through the basic operational aspects of developing code in
\aipspp.

\subsection*{Setup}

Basic \aipspp\ programmer setup was described in \sref{AIPS++ programmer
setup}.  To recapitulate the main points
\begin{itemize}
\item
   If you will be checking sources into and out of the \aipspp\ master (i.e.
   an \aipspp\ consortium programmer) then make sure you are a member of the
   \aipspp\ programmer group, the conventional name of which is
   \acct{aips2prg}.

\item
   Modify your shell's login script (\file{.login}, \file{.profile}, etc.) to
   invoke \exeref{aipsinit} to define the \aipspp\ environment.

\item
   Invoke \exeref{mktree} to create an \aipspp\ workspace.
\end{itemize}

The \aipspp\ makefiles normally deposit binary files in the same directory as
programmer source files unless you create separate directories for them.  If
you intend to compile sources for more than one architecture or compiler then
you should create these directories.  A good strategy is to maintain sources
within your home directory (which presumably is backed up) and relegate the
binaries to some other filesystem with more space but not backed up.  Hence
typically

\begin{verbatim}
   mkdir /bigdisk/myarea/sun4sol_gnu/{aux,bin,bindbg,lib,libdbg}
   ln -s /bigdisk/myarea/sun4sol_gnu $HOME/aips++/sun4sol_gnu
\end{verbatim}

\noindent
Do this for each \aipspp\ architecture that you are likely to use.  The
\aipspp\ makefiles will discover and use these directories automatically.  You
can use \exeref{aipsinit} to switch between architectures at any time.

\subsection*{Modifying existing sources}

Once your workspace is set up the \aipspp\ makefiles allow you to compile
system sources without having to check them out into your workspace.
Programmer-oriented makefile targets are described in \sref{Code development
makefile rules}.  Typically it is enough to invoke \exeref{gmake} without
any targets.  Use

\begin{verbatim}
   gmake help
\end{verbatim}

\noindent
to get a context-sensitive summary of the \aipspp\ targets for each directory.
Programmer-oriented targets are discussed in section \sref{Code development
makefile rules}.

If you wish to modify a source file then

\begin{itemize}
\item
   If you are a consortium programmer and intend to change the master source
   code then check out the relevant source file using \exereff{ao -l}{ao} or
   \exereff{rao -l}{rao}.  If you do not intend to update the master then
   omit the \exe{-l} flag.

\item
   If you are not a consortium programmer or only wish to work within your
   local system then
   \begin{itemize}
   \item
      If a copy of the \rcs\ repository is maintained in your installation (as
      indicated by the presence of the \file{\$AIPSROOT/rcs} directory) and
      you intend to update your installation then check out the source file
      using \unixexe{co -l}.  If you do not intend to update the local system
      then omit the \exe{-l} flag.

   \item
      Otherwise, if your installation does not contain a copy of the \rcs\ 
      source repository then simply copy the relevant system file to your
      workspace directory.
   \end{itemize}
\end{itemize}

\noindent
Once you've modified the file you can compile it in your workspace without
affecting the system binaries.  When you're satisfied with your changes

\begin{itemize}
\item
   If you want to update the \aipspp\ master check the file in with
   \exeref{ai} or \exeref{rai}.  If you also want to update the local slave
   \rcs\ repository then do so with \exeref{au} or \exeref{rau}.  You can
   combine the two operations via \exe{ai -au} or \exe{rai -au}.
   \\Changes need to be documented in the \aipspp\ changelog file using
   \exeref{ac} or \exeref{rac}.

\item
   Use \unixexe{ci} if you only want to update the local \rcs\ repository.

\item
   If your installation does not contain a copy of the \rcs\ source repository
   then simply copy the file to the system directory.
\end{itemize}

\noindent
If you want to update the system binaries you will need to issue a

\begin{verbatim}
   gmake allsys
\end{verbatim}

\noindent
This can be done from a programmer workspace (although some installations
explicitly prevent this by removing write permission for \acct{aips2prg} from
the \aipspp\ system directories).

\subsection*{The gmake command line - flags and variable definitions}

\exeref{gmake} has several command line options which are frequently useful
for \aipspp\ programmers.

\begin{itemize}
\item
   \exe{--help}: Print usage information and exit without processing any
   makefiles.

\item
   \exe{-i}: Ignore all  errors  in  commands  executed  to  remake files.

\item
   \exe{-k}: Continue as much as possible after an error.   While the target
   that failed, and those that depend on it, cannot be remade, the other
   dependencies of these targets can be processed all the same.

\item
   \exe{-n}: Print the commands that would be executed, but do not execute
   them.

\item
   \exe{-W}: Pretend that the target file has just been modified.  When used
   with the \exe{-n} flag, this shows you what would happen if you were to
   modify that file.  Without \exe{-n}, it is almost the same as running a
   \unixexe{touch} command on the given file before running \exeref{gmake},
   except that the modification time is changed only in the imagination of
   \exe{gmake}.
\end{itemize}

\noindent
Note that the default \filref{makedefs} sets the \exe{--no-print-directory}
internally (via \code{MAKEFLAGS}) and also sets \exe{-i} for system invokation
but not for programmer invokation.  Consult the unix manual page for
\aipsexe{gmake} for further options or use

\begin{verbatim}
   gmake --help
\end{verbatim}

\noindent
Do not confuse this with

\begin{verbatim}
   gmake help
\end{verbatim}

\noindent
which is an \aipspp\ target which lists \aipspp\ targets.  Note also that you
should eschew usage of the \exe{-e} option (environment variables override
makefile variables) unless you fully understand its implications.

The other important aspect of \aipsexe{gmake} invokation is that makefile
variables may be defined on the command line and these (usually) override
their definition within the makefile.  The makefiles use separate sets of
variables for system and programmer compilations, so for example, system
\cplusplus\ compilations use \code{C++DBG} and \code{C++OPT} for debug and
optimized compilations whereas \code{C++FLAGS} is used for programmer
compilations.  The default \filref{makedefs} sets

\begin{verbatim}
   ifdef OPT
      C++FLAGS  = $(C++OPT) $(EXTRA_C++FLAGS)
   else
      C++FLAGS  = $(C++DBG) $(EXTRA_C++FLAGS)
   endif
\end{verbatim}

\noindent
although as described in section \sref{Code development makedefs conventions}
the site-specific makedefs may redefine this, for example as

\begin{verbatim}
   ifdef OPT
      C++FLAGS := -O$(OPT) -pipe
   else
      C++FLAGS := $(C++DBG)
   endif

   C++FLAGS += $(EXTRA_C++FLAGS)
\end{verbatim}

Either way, this example shows three basic types of command-line variable
substitutions

\begin{itemize}
\item
   Variables such as \code{OPT} which are used as switches.  In the second
   example it is used as a switch and an optimization level.  It might be used
   as

   \begin{verbatim}
      gmake OPT=2 myprog
   \end{verbatim}

\item
   The \code{C++FLAGS} variable itself can be completely redefined on the
   command line, for example

   \begin{verbatim}
      gmake C++FLAGS="-O4 -fast -target=native" myprog
   \end{verbatim}

\item
   The \code{EXTRA\_C++FLAGS} variable can be used to add extra options to
   \code{C++FLAGS}, for example

   \begin{verbatim}
      gmake EXTRA_C++FLAGS="-fast" myprog
   \end{verbatim}

\end{itemize}

\noindent
As discussed in section \sref{Diagnostic makefile rules}, a list of variables
of specific interest to programmers may be obtained via

\begin{verbatim}
   gmake show_prg
\end{verbatim}

\noindent
This may be used to show the value of the variables which would be used in a
particular situation, for example

\begin{verbatim}
   gmake OPT=2 EXTRA_C++FLAGS="-fast" show_prg
\end{verbatim}

\noindent
The variables of interest to programmers are described in more detail in
section \sref{Code development makefile rules}.

As suggested above, the site-specific \filref{makedefs} may be used to alter
the construction of programmer variable definitions.  Several conventional
constructions are discussed in section \sref{Code development makedefs
conventions}.  Programmers may also implement their own definitions or
constructions in a personal \file{makedefs} file as discussed in the same
section.

\subsection*{Creating new files and directories}

If you want to develop a new directory in the \aipspp\ hierarchy, usually to
contain a class implementation module or a new application, then simply create
that directory in your workspace.  Likewise, new files may simply be created -
the \aipspp\ makefiles do not contain lists of files but use the file suffix
to determine how to process a file.  Recognized file suffixes are listed in
section \sref{makefiles}.

All \aipspp\ directories (except for \file{.dir} and \file{tmplinst}
directories) must contain a makefile which must be called \file{makefile}.
Typically this need only include one of the generic \aipspp\ makefiles (see
\sref{makefiles}).  For example, when creating a new application the minimum
requirement would be

\noindent
\verb+   # $+\verb+Id$+

\begin{verbatim}
   # Use the generic AIPS++ application makefile.
   #---------------------------------------------
   include $(word 1, $(AIPSPATH))/code/install/makefile.app
\end{verbatim}

\noindent
Once you have finished development the new directory may be checked in to the
master via \exeref{ai}.  However, you may receive a message to the effect that
permission for the operation is denied - creation of new files and directories
in many parts of the master is restricted to particular individuals since all
new code must be vetted by the ``Code-Cop''.

\subsection*{makefiles}

The makefiles which exist in the \aipspp\ source directories mostly just
include a generic makefile but some need to supply additional information.

For an application you often need to register any required external libraries
and may also want to define some preprocessor directives as described in
section \sref{Object libraries}:

\noindent
\verb+   # $+\verb+Id$+

\begin{verbatim}
   # Use the generic AIPS++ application makefile.
   #---------------------------------------------
   XLIBLIST := GLISH WCSLIB F77
   CPPMODU  := -DFOO -DBAR
   include $(word 1, $(AIPSPATH))/code/install/makefile.app
\end{verbatim}

\noindent
The \code{XLIBLIST} and \code{CPPMODU} variables are relevant to the
\file{app}, \file{imp}, and \file{tst} makefiles.

The documentation makefile requires arguments to be specified for conversion
of \LaTeX\ documents to \textsc{html} via \unixexe{latex2html}.  Typically

\noindent
\verb+   # $+\verb+Id$+

\begin{verbatim}
   # Declare latex2html flags.
   System := -split 2
   Coding := -split 3

   # Use the generic AIPS++ documentation makefile
   #----------------------------------------------
   include $(word 1, $(AIPSPATH))/code/install/makefile.doc
\end{verbatim}

\noindent
This example declares that \unixexe{latex2html} should be run on
\file{System.latex} and \file{Coding.latex}.  No other files in the directory
with a \file{.latex} suffix will be converted to \textsc{html} although they
will be converted to \textsc{PostScript}.  At the minimum the variable of
the same basename as the \file{.latex} file should specify a \code{-split}
argument to \unixexe{latex2html}, but it can also specify any other arguments
recognized by it.

This example also illustrates that \LaTeX\ documents must have a \file{.latex}
suffix to distinguish them from plain \TeX\ documents.

Adjunct \file{makedefs} files may contain definitions (or, in principle,
rules) which apply to a particular source code directory.  The adjunct files
are architecture-specific and are primarily intended to control compiler
options on a per-sourcefile basis.  This is an advanced topic discussed in
section \sref{makedefs adjuncts}.

\subsection*{See also}

Section \sref{Accounts and groups}, \aipspp\ accounts and groups.

% ----------------------------------------------------------------------------

\newpage
\section{Coding conventions}
\label{Coding conventions}
\index{code!development!conventions}
\index{code!development!include files}
\index{code!development!html@\textsc{html}}
\index{code!development!perl scripts@\unixexe{perl} scripts}
\index{conventions|see{code, development}}
\index{documentation!coding conventions|see{code, development}}
\index{include files!coding conventions|see{code, development}}
\index{perl@\unixexe{perl} scripts!coding conventions|see{code, development}}
\index{html@\textsc{html}!coding conventions|see{code, development}}

This section discusses some aspects of the \aipspp\ system which have a direct
effect on the way source code is written.

\subsection*{Include files}

It is essential in \aipspp\ that the

\begin{verbatim}
   #include <Header.h>
\end{verbatim}

\noindent
form of preprocessor \code{\#include} statement be used.  This form looks for
\file{Header.h} in the search path defined by \exe{-I} compiler options and
allows the \aipspp\ makefiles to control the include process.  The other form
admitted by the \textsc{c} preprocessor, namely

\begin{verbatim}
   #include "Header.h"
\end{verbatim}

\noindent
should never be used in \aipspp\ source code.  It causes the preprocessor to
look for the include file in the same directory as the source file, regardless
of the search path defined by \exe{-I} compiler options.  This may cause
problems where, for example, a programmer has checked out and is modifying a
\cplusplus\ class implementation file but doesn't have the relevant header
files checked out alongside.

Include files are specified as in the following example:

\begin{verbatim}
   #include <aips/Tables/Table.h>
\end{verbatim}

\noindent
This refers to the specific header file
\file{\$(AIPSCODE)/aips/implement/Tables/Table.h} by virtue of the symlink

\begin{verbatim}
   $(AIPSCODE)/include/aips -> $(AIPSCODE)/aips/implement
\end{verbatim}

\noindent
and the fact that \file{\$(AIPSCODE)/include} is added to the include path via
a \exe{-I} compiler option (see \sref{Code directories}).  Symlinks for each
package are created by the \code{symlinks} rule in the top-level makefile
(\sref{System generation makefile rules}), and they are created in programmer
workspaces by \exeref{mktree}.

Another caveat on include files is that they {\em must} have a \file{.h}
file suffix.  This is mandated by the need for \code{vpath} directives in the
makefiles, specifically for the dependency analysis used in programmer
compilations.

\subsection*{perl scripts}

\unixexe{perl} scripts must begin with a line of the form

\begin{verbatim}
   #!/usr/local/bin/perl4
\end{verbatim}

\noindent
or

\begin{verbatim}
   #!/usr/local/bin/perl5
\end{verbatim}

\noindent
When the scripts are installed the makefile will replace these strings with
the full pathname to the \unixexe{perl4} or \unixexe{perl5} executable encoded
in the \code{PERL4} and \code{PERL5} \file{makedefs} variables.  \unixexe{perl}
options may be added after these strings in the usual way.

\subsection*{Documentation include files}

Files included by \TeX , \LaTeX\, and Texinfo source files may be deposited in
a subdirectory with the same basename as the source file but with a
\file{.dir} suffix.  For example, the source for this manual consists of
\file{System.latex} which simply defines the document style and a few commands
and environments and then includes a separate \file{.tex} file for each
chapter.  \file{System.latex} resides in \file{\$AIPSCODE/doc/reference} and
the chapters reside in \file{\$AIPSCODE/doc/reference/System.dir}.

The documentation makefile automatically adds any \file{.dir} subdirectory to
the \code{TEXINPUTS} environment variable which defines \TeX 's search path
for included files.  Note that, while \file{.dir} subdirectories can contain
any type of file, \TeX , \LaTeX\, and Texinfo may themselves impose
constraints, for example \LaTeX\ requires a \file{.tex} file suffix for
included files.

The \file{.dir} subdirectories should not contain a makefile, nor should they
have subdirectories.  Other than that there is really no restriction on
what they may contain.

\subsection*{URLs in \textsc{html} documents}

Because \aipspp\ \textsc{html} documents are propagated to many sites and
installed with minimal changes it is important that the URLs (Uniform Resource
Locators) in these documents be relative to \code{\$AIPSDOCS} whenever
possible.  Someone navigating the \aipspp\ documentation at one site should
not be directed to another \aipspp\ installation without needing to be.  Once
such a traversal is made the error is compounded since the links stay remote
unless the link stack is unwound.

A document in a subdirectory of \code{\$AIPSCODE/doc} is installed within the
corresponding subdirectory of \code{\$AIPSDOCS}.  For example,
\file{\$AIPSCODE/doc/html/homepage.html} is installed in
\file{\$AIPSDOCS/html/homepage.html}.  Thus a link from \file{homepage.html}
to, say, \file{\$\$AIPSDOCS/projects/mission.html} should be given as

\begin{verbatim}
   <A HREF="../project/mission.html">Mission Statement</A>
\end{verbatim}

\noindent
The following prescription should be observed:

\begin{itemize}
\item
   {\em Use a relative URL} if the linked-to file exists (or ought to exist)
   in all \aipspp\ installations.

\item
   {\em Use an absolute URL} if the linked-to file does not exist in all
   \aipspp\ installations.  Typically these would be links to web services
   provided by the master as described in \sref{web services}.
\end{itemize}

\subsection*{HTML meta-markups}

The \textsc{html} comment

\noindent
\verb+   <!$+\verb+Date$>+

\noindent
may be used to automatically record timestamp information in the installed
\textsc{html} file.  The following fragment shows an example of its use,
typically near the end of the file:

\begin{verbatim}
   <P>Copyright &#169; 1996-98,2000,2001 Associated Universities Inc., Washington, D.C.</P>
   <ADDRESS>aips2adm@nrao.edu</ADDRESS>
\end{verbatim}

\noindent
\verb+   <!$+\verb+Date$>+

\begin{verbatim}
   </BODY>
   </HTML>
\end{verbatim}

\noindent
\rcs\ substitutes the current time (GMT) for the \verb+$+\verb+Date$+ string
when the file is checked in (see \exeref{ai}) thereby transforming the
meta-markup to something resembling

\noindent
\verb+   <!$+\verb+Date: 1995/08/04 05:22:48 $>+

\noindent
The documentation makefile parses this into \textsc{html} and also adds the
time when the \file{.html} file was installed in the relevant subdirectory of
\file{\$AIPSDOCS} (see \sref{variables}).  Within an \textsc{html} browser the
result is as follows:

\begin{verbatim}
   Copyright (c) 1995-98,2000,2001 Associated Universities Inc., Washington, D.C.

   aips2adm@nrao.edu

   ---------------------------------------------------------------------------

   Modified:  1995/08/04 05:22:48 GMT
   Installed: 1995/08/06 19:32:08 GMT
\end{verbatim}

\noindent
It is permissable to insert additional text within the meta-markup as follows:

\noindent
\verb+   <!$+\verb+Date$ by mcalabre@atnf.csiro.au>+

\noindent
This would appear as:

\begin{verbatim}
   Copyright (c) 1995-98,2000,2001 Associated Universities Inc., Washington, D.C.

   aips2adm@nrao.edu

   ---------------------------------------------------------------------------

   Modified:  1995/08/04 05:22:48 GMT by mcalabre@atnf.csiro.au
   Installed: 1995/08/06 19:32:08 GMT
\end{verbatim}

\noindent
The \verb+<!$+\verb+Date$>+ meta-markup must appear as the first and only text
on a line (with no leading whitespace).  It should be the last item before the
\code{</BODY>} \textsc{html} markup.

% ----------------------------------------------------------------------------

\newpage
\section{Code development makedefs conventions}
\label{Code development makedefs conventions}
\index{code!development!makedefs@\file{makedefs}}
\index{makedefs@\file{makedefs}!code development}
\index{makefile!application}
\index{makefile!applications}
\index{makefile!checkout}
\index{makefile!class implementation}
\index{makefile!documentation}
\index{makefile!fortran@\textsc{fortran}}
\index{makefile!install}
\index{makefile!package}
\index{makefile!scripts}
\index{makefile!test}
\index{makefile!top-level}
\index{compilation!code development|see{code, development}}

\subsection*{Conventions for \file{makedefs} variable definitions}

Some features of the \aipspp\ programmer compilations are defined as
conventions for variable usage which are implemented within \filref{makedefs}
itself.

\textbf{Optimized programmer compilations:}

By default, programmer compilations are usually done in debug mode.
Specifying \code{OPT=1} (or \code{2}, \code{3}, \code{4}, ...) on the
\exeref{gmake} command line signals that programmer compilations are to be
done at the corresponding optimization level.  For example

\begin{verbatim}
   gmake OPT=1 Foo.o
\end{verbatim}

\noindent
If the \code{OPT} variable is defined the default \filref{makedefs} will set
all programmer compile options to be the same as used for optimized system
compilations.  However, alternate levels of optimization must be implemented
in the site-specific \file{makedefs}; the example below shows how this might
be done.  If \code{OPT} has been set then programmer executables will be
linked to the optimized system libraries (if they exist).

The \code{OPT} variable is not intended to (and should not be made to) affect
system compilations.

\textbf{Alternate programmer compilation options:}

Another convention in use for programmer compilations is that of setting
compiler \code{*FLAGS} variables on the command line to \code{alt1},
(\code{alt2}, ...).  For example,

\begin{verbatim}
   gmake C++FLAGS=alt1 Foo.o
\end{verbatim}

\noindent
This is a signal to the site-specific \filref{makedefs} to substitute a
predefined, locally standard, set of compiler options.  By convention,
\code{alt1} should be defined to do an optimized compilation of the same level
as the system optimized compilation.

\textbf{Adding extra programmer compilation options:}

Programmers may supplement the compilation options defined within
\filref{makedefs} by use of \code{EXTRA\_*FLAGS}, for example

\begin{verbatim}
   gmake EXTRA_C++FLAGS="+p -pipe" Foo.o
\end{verbatim}

\noindent
which would cause "\code{+p -pipe}" to be appended to the value of
\code{C++FLAGS} defined within \file{makedefs}.  If any of the extra options
are incompatible with, or contradict the options set in \file{makedefs} then
compiler-specific behaviour will result.

\textbf{Redefining programmer compilation options in full:}

Strictly speaking this is not a \filref{makedefs} convention, but nevertheless
it's worth pointing out that \file{makedefs} must not prevent programmer
variables from being redefined in full on the \exeref{gmake} command line.  In
practice this simply means that \file{makedefs} must not use the
\code{override} directive when defining programmer compilation variables
(except in implementing the alternate options as described below).

\textbf{Implementing the conventions:}

The conventions on programmer compilation options must be implemented within
the site-specific \filref{makedefs}.  However, they need not be implemented if
they are not required.  Since considerable latitude is available in their
precise interpretation a \code{show\_prg} target has been provided for
programmers to print the values of all variables likely to be affected.  The
following fragment shows a realistic example of how the \code{C++FLAGS}
variable might be defined in the site-specific \file{makedefs}:

\begin{verbatim}
   ifdef OPT
      C++FLAGS := -ptr$(PGMRPTRD) -pta -O$(OPT) +p -pipe -ptv
   else
      C++FLAGS := -ptr$(PGMRPTRD) $(C++DBG)
   endif

   ifeq "$(C++FLAGS)" "alt1"
      override C++FLAGS := -ptr$(PGMRPTRD) $(C++OPT)
   endif

   ifeq "$(C++FLAGS)" "alt2"
      override C++FLAGS := -ptr$(PGMRPTRD) $(C++DBG) -ptv
   endif

   C++FLAGS += $(EXTRA_C++FLAGS)
\end{verbatim}

\noindent
An important point to note here is that if \code{C++FLAGS} is defined on the
command line then a redefinition within \filref{makedefs} has no effect unless
the \code{override} directive is used.  The variables which define programmer
compilation options are \code{CPPFLAGS}, \code{CFLAGS}, \code{C++FLAGS},
\code{FFLAGS}, and \code{LDFLAGS}.

\textbf{Programmer binary directories:}

The \code{PGMRINCD}, \code{PGMRAUXD}, \code{PGMRLIBD}, and \code{PGMRBIND}
variables specify where the output from programmer compilations is to be
deposited.  \code{PGMRINCD} is used for the output of the \unixexe{lex} and
\unixexe{bison} parser/generators, and \code{PGMRAUXD} contains the results of
programmer dependency analyses.  The default \filref{makedefs} sets these, and
also \code{PGMRPTRD}, to

\begin{verbatim}
   PGMRINCD := $(wildcard $(PGMRARCH))
   PGMRAUXD := $(wildcard $(PGMRARCH)/aux)
   PGMRLIBD := $(wildcard $(PGMRARCH)/lib)
   PGMRBIND := $(wildcard $(PGMRARCH)/bin)
   PGMRPTRD  = $(PGMRARCH)/ptrepository
\end{verbatim}

\noindent
In other words, the \file{\$(PGMRARCH)}, \file{\$(PGMRARCH)/aux},
\code{\$(PGMRARCH)/lib}, and \code{\$(PGMRARCH)/bin} directories will be used
{\em if they exist}.  If they don't, then \code{PGMRINCD}, \code{PGMRLIBD}
and/or \code{PGMRBIND} will be blank and the corresponding output will be
left in the programmer's source code directories.  The site-specific
\filref{makedefs} files can reset these variables as it sees fit, except that
if they're not blank, then they must specify absolute pathnames.  Note that
this facility uses the \exe{-o} compiler option for object modules so
\code{PGMRLIBD} must not be set for compilers which do not support it.

The site-specific \file{makedefs} may wish to redefine \code{PGMRLIBD} and
\code{PGMRBIND} depending on the value of \code{OPT} in order to separate the
binaries produced for different levels of optimization.  The default is to put
debug and optimized binaries in the same place.

\subsection*{Programmer makedefs}

Programmers can maintain makefile variable definitions (and rules) within a
private \aipsfil{makedefs} file.  This is included after the site-specific
\file{makedefs} so that it's possible to override any site definitions.  The
programmer \file{makedefs} must reside in the architecture-specific
subdirectory of the root of the programmer's workspace.  For example, if the
\aipspp\ architecture is \code{sun4sol\_gnu} and the programmer's workspace is
rooted at \file{\$HOME/aips++} then the programmer \file{makedefs} must be
\file{\$HOME/aips++/sun4sol\_gnu/makedefs}.  Of course, this file could
include \file{makedefs} definitions from elsewhere.

\subsection*{See also}

The \textsc{gnu} \code{Make} manual.\\
The \textsc{gnu} manual page for \unixexe{gmake}.\\
\aipspp\ variable names (\sref{variables}).\\
\exeref{gmake}, \textsc{gnu} make.\\
\filref{makedefs}, \aipspp\ makefile definitions.

% ----------------------------------------------------------------------------

\newpage
\section{Code development makefile rules}
\label{Code development makefile rules}
\index{code!development!makefile rules}
\index{makefile!rules!code development}
\index{makefile!application}
\index{makefile!applications}
\index{makefile!checkout}
\index{makefile!class implementation}
\index{makefile!documentation}
\index{makefile!fortran@\textsc{fortran}}
\index{makefile!install}
\index{makefile!package}
\index{makefile!scripts}
\index{makefile!test}
\index{makefile!top-level}

Use of the \aipspp\ makefiles for code development.

\subsection*{Synopsis}

\begin{synopsis}
   \file{makefile}\\
   \file{makefile.\{app,aps,chk,doc,ftn,imp,pkg,scr,tst\}}
\end{synopsis}

\subsection*{Description}

The \aipspp\ code development targets are listed below by category.  These
lists are not exhaustive, but do aim to cover everything of practical use.  In
particular, they omit targets which are intended for the internal use of the
makefiles.

A target is labelled as ``recursive'' if it causes \exeref{gmake} to be
invoked in all subdirectories.  It is ``general'' if it applies to all
makefiles; such targets are defined in \filref{makedefs}.  A target is
``specific'' if defined in a specific makefile.

Some targets such as \file{allsys} have a general meaning, the specific
behaviour of which differs for specific makefiles.  These are referred to as
``general/specific'' and where appropriate the details of a target's behaviour
are described for each of the generic makefiles, for the top-level makefile
(\file{top}), and the installation makefile (\file{ins}).

Targets which apply only if the \rcs\ source code repositories are present
are marked as ``\rcs''.

\textbf{Programmer-oriented variables:}

Rules for programmer-oriented targets look for source files first in the
programmer directory and if not found search the corresponding subdirectory of
\file{\$AIPSCODE} which is referred to below as \file{\$(CODEDIR)}.  This means
that programmers can compile code in their own workspace without having to
copy source files from \file{\$(CODEDIR)}, thereby minimizing the number of
files that need to be present in the programmer's workspace and reducing the
possibility that these may be ``stale''.

Certain variables are defined in \filref{makedefs} for the exclusive use of
programmer-oriented rules and may be redefined as necessary on the
\exeref{gmake} command line.  These are:

\begin{itemize}
\item
   \code{PGMRINCD}
   \\ Repository for include files produced by parser/generators such as
   \unixexe{lex} and \unixexe{bison}.

   The default \file{makedefs} sets this to \file{\$PGMRARCH} if that directory
   exists (but the site-specific \file{makedefs} may redefine it).

   Output is left in the current directory if \file{\$PGMRINCD} is blank.

\item
   \code{PGMRAUXD}
   \\ Repository for dependency lists and timestamp files generated by the
   programmer dependency analysis.

   The default \file{makedefs} sets this to \file{\$PGMRARCH/aux} if that
   directory exists (but the site-specific \file{makedefs} may redefine it).

   Output is left in the current directory if \file{\$PGMRAUXD} is blank.

\item
   \code{PGMRLIBD}
   \\ Programmer directory for class object modules and libraries.

   The default \file{makedefs} sets this to \file{\$PGMRARCH/lib} if that
   directory exists (but the site-specific \file{makedefs} may redefine it).

   Output is left in the current directory if \file{\$PGMRLIBD} is blank.

\item
   \code{PGMRBIND}
   \\ Directory where programmer executables are deposited; programmers should
   add this directory to their \code{PATH}.

   The default \file{makedefs} sets this to \file{\$PGMRARCH/bin} if that
   directory exists (but the site-specific \file{makedefs} may redefine it).

   Output is left in the current directory if \file{\$PGMRBIND} is blank.

\item
   \code{PGMRPTRD}
   \\ Directory serving as the programmer template repository.

   The default \file{makedefs} sets this to \file{\$PGMRARCH/ptrepository} as a
   suggestion and for the convenience of the site-specific \file{makedefs} in
   setting compiler options.  However, the site-specific \file{makedefs} may
   redefine it or simply ignore it, and \code{PGMRPTRD} is not used directly
   by any of the makefiles.

   Defaults to a compiler-specific directory if blank.

\item
   \code{EXTRA\_PGMRINCL}
   \\ Extra include directories to be {\em prepended} to the internally
   defined include path, \code{PGMRINCL}, which may also be redefined.

\item
   \code{EXTRA\_PGMRLIBS}
   \\ Extra object libraries to be {\em appended} to the internally
   defined library list, \code{PGMRLIBS}, which may also be redefined.

\item
   \code{OPT}
   \\ Optimization level to use for compilations.  The exact meaning of this
   is defined in the site-specific \file{makedefs} file.

\item
   \code{OPTLIB}
   \\ This variable may be set (to anything) to force a debug programmer
   compilation to link to the optimized system libraries.  This is useful
   for reducing the size of executables and the time taken to link them if
   you only wish to debug your own code.

\item
   \code{*FLAGS}
   \\ Options to be used for programmer compilations (\code{CPPFLAGS},
   \code{CFLAGS}, \code{C++FLAGS}, \code{FFLAGS}, \code{LDFLAGS} and
   \code{CXXARFLAGS}).

\item
   \code{EXTRA\_*FLAGS}
   \\ Extra compiler flags to be appended to \code{*FLAGS} (\code{CPPFLAGS},
   \code{CFLAGS}, \code{C++FLAGS}, \code{FFLAGS}, \code{LDFLAGS} and
   \code{CXXARFLAGS}).
\end{itemize}

\noindent
These variables may be printed with the \code{show\_prg} target.  The
\code{*FLAGS} variables are the subject of a convention for setting alternate
programmer compilation flags described in the section on \ref{Code development
makedefs conventions}.

\textbf{Programmer-oriented targets:}

The programmer-oriented targets are as follows; note that where targets are
defined in terms of a \exeref{gmake} variable, for example \file{\$(SUBDIRS)},
it, and all other variables, may be printed via the \code{show\_all} target:

\begin{itemize}
\item
   \code{all} : (default programmer target, general/specific)
   \\ This is declared generally in \file{makedefs} as the default target if
   \exeref{gmake} has {\em not} been invoked from a subdirectory of
   \file{\$AIPSCODE}.  Its dependencies and commands are defined in the
   specific makefiles to compile all object modules, executables, etc. from
   files in the current directory.
   \begin{itemize}
   \item
      \file{app}: Compile this application and put the executable in
      \file{\$(PGMRBIND)}.
   \item
      \file{aps}: Compile all applications which have their main \file{.cc}
      file in the programmer's workspace and put the executables in
      \file{\$(PGMRBIND)}.
   \item
      \file{chk}: Does nothing.
   \item
      \file{doc}: Compile all \file{info} files and \textsc{PostScript}
      documents with sources in the current directory.
   \item
      \file{ftn}: Update all programmer object library modules which have
      sources in the current directory.
   \item
      \file{imp}: Update all programmer object library modules which have
      sources in the current directory.
   \item
      \file{ins}: Compile all utility programs with sources in the current
      directory.
   \item
      \file{pkg}: Does nothing.
   \item
      \file{src}: Does nothing.
   \item
      \file{top}: Create the \file{include} subdirectory and populate it with
      symbolic links to the \file{implement} directories of all installed
      packages (see \exeref{mktree}).
   \item
      \file{tst}: Compile all test programs with sources in the current
      directory and put the executables in \file{\$(PGMRBIND)}.
   \end{itemize}

\item
   \file{\$(SUBDIRS)} : (general)
   \\ \file{makedefs} sets the \code{SUBDIRS} variable to the names of all
   subdirectories which have a makefile, thus making them recognized targets.
   If the \rcs\ source code repositories exist then \file{\$(SUBDIRS)} lists
   the subdirectories of the corresponding \rcs\ directory.  This list is then
   made the target of a rule for creating the subdirectory and its \file{RCS}
   symlink (see \exeref{mktree}), and initiating a \exeref{gmake} within it.
   Note that this target has a system-oriented counterpart which behaves
   similarly.

\item
   \code{clean} : (general/specific)
   \\ This target causes intermediate files to be deleted.  It is defined
   generally in \file{makedefs} with a dependency which may be defined in the
   specific makefiles as the target of a rule to delete additional files.
   General files deleted are \file{*~}, \file{*\%}, \file{a.out},
   and \file{core}.  The specific makefiles may delete more:
   \begin{itemize}
   \item
      \file{app}: Deletes \file{*~}, \file{*\%}, and \file{\$(PCKGMOD).lock}
      from the \file{\$(PGMRAUXD)} directory, and deletes \file{*.i},
      \file{*.o}, \file{*.cdb}, \file{*.cyi}, \file{a.out}, and \file{core}
      from the \file{\$(PGMRBIND)} directory.
   \item
      \file{aps}: Deletes \file{*~}, \file{*\%}, and \file{\$(PACKAGE)=*.lock}
      from the \file{\$(PGMRAUXD)} directory, and deletes \file{*.i},
      \file{*.o}, \file{*.cdb}, \file{*.cyi}, \file{a.out}, and \file{core}
      from the \file{\$(PGMRBIND)} directory.
   \item
      \file{chk}: (none)
   \item
      \file{doc}: \file{*.aux}, \file{*.bbl}, \file{*.blg}, \file{*.cp},
      \file{*.cps}, \file{*.dvi}, \file{*.fi}, \file{*.fis}, \file{*.fn},
      \file{*.fns}, \file{*.idx}, \file{*.ilg}, \file{*.ind}, \file{*.ky},
      \file{*.kys}, \file{*.lof}, \file{*.log}, \file{*.pg}, \file{*.pgs},
      \file{*.toc}, \file{*.tp}, \file{*.tps}, \file{*.vr}, \file{*.vrs},
      \file{*.info}, \file{*.info-*}
   \item
      \file{ftn}: Deletes \file{*.o} \file{a.out}, and \file{core} from the
      \file{\$(PGMRLIBD)} directory.
   \item
      \file{imp}: Deletes \file{*.i}, \file{*.o}, \file{*.cdb},
      \file{*.cyi}, \file{a.out}, and \file{core} from the \file{\$(PGMRLIBD)}
      directory, deletes \file{*~}, \file{*\%}, \file{*.lcc}, and \file{*.ycc}
      from the \file{\$(PGMRINCD)} directory, and deletes \file{*~},
      \file{*\%} and \file{\$(PCKGMOD).lock} from the \file{\$(PGMRAUXD)}
      directory.
   \item
      \file{ins}: \file{*.i}, \file{*.o}
   \item
      \file{pkg}: (none)
   \item
      \file{src}: (none)
   \item
      \file{top}: (none)
   \item
      \file{tst}: Recursively deletes \file{*\_tmp*} from the current
      directory, deletes \file{*~} and \file{\$(PCKGMOD).lock} from the
      \file{\$(PGMRAUXD)} directory, and deletes \file{*.i}, \file{*.o},
      \file{*.cdb}, \file{*.cyi}, \file{a.out}, and \file{core} from the
      \file{\$(PGMRLIBD)} and \file{\$(PGMRBIND)} directories.
   \end{itemize}

\item
   \code{cleaner} : (general/specific)
   \\ This target is defined generally in \file{makedefs} with a dependency
   which may be defined in the specific makefiles as the target of a rule to
   delete additional files.  Generally this target invokes the \code{clean}
   target and then deletes source files in the current directory which have
   been checked out without a lock.  It determines these as any file in the
   current directory without write permission and with a corresponding
   \rcs\ version file.  The specific makefiles may go further:
   \begin{itemize}
   \item
      \file{app}: For the application with source code in the current
      directory or \file{\$(CODEDIR)}; deletes the associated dependency list
      and timestamp files, deletes the programmer library for the application,
      recursively deletes any \file{tmplinst} subdirectory (see
      \exeref{mkinst}), and deletes the executable for the application.
   \item
      \file{aps}: Deletes the dependency lists and timestamp files for all
      applications in this package, and deletes the executables for any
      applications with source code in system or programmer application
      subdirectories.
   \item
      \file{chk}: (none)
   \item
      \file{doc}: Deletes all \file{.ps} files generated from \file{.latex},
      \file{.texi}, or \file{.tex} files, and recursively deletes all
      directories generated by \unixexe{latex2html} from \file{.latex}
      sources.
   \item
      \file{ftn}: Deletes the programmer's private \textsc{fortran} library
      for the package.
   \item
      \file{imp}: Deletes the dependency lists and timestamp files for the
      package/module, and deletes the programmer's private \cplusplus\ library
      for the package.
   \item
      \file{ins}: Deletes the executables for any utility programs with source
      code in the current directory or \file{\$(CODEDIR)}.
   \item
      \file{pkg}: (none)
   \item
      \file{scr}: (none)
   \item
      \file{top}: (none)
   \item
      \file{tst}: For all test programs with source code in the current
      directory or \file{\$(CODEDIR)}; deletes the associated dependency lists
      and timestamp files, deletes the programmer library, recursively deletes
      any \file{tmplinst} subdirectory (see \exeref{mkinst}), and deletes the
      executables.
   \end{itemize}

\item
   \code{cleanest} : (general/specific)
   \\ This target is defined generally in \file{makedefs} with a dependency
   which may be defined in the specific makefiles as the target of a rule to
   delete additional files.  Generally this target just invokes the
   \code{cleaner} target.  The specific makefiles may go further:
   \begin{itemize}
   \item
      \file{app}: (none)
   \item
      \file{aps}: (none)
   \item
      \file{chk}: (none)
   \item
      \file{doc}: (none)
   \item
      \file{ftn}: (none)
   \item
      \file{imp}: Deletes {\em all} of the programmer's dependency lists and
      timestamp files in \file{\$(PGMRAUXD)}, deletes {\em all} object
      libraries in \file{\$(PGMRLIBD)}, recursively deletes the programmer's
      template repository \file{\$(PGMRPTRD)}, and recursively deletes any
      \file{tmplinst} subdirectory (see \exeref{mkinst}).
   \item
      \file{ins}: (none)
   \item
      \file{pkg}: (none)
   \item
      \file{scr}: (none)
   \item
      \file{top}: (none)
   \item
      \file{tst}: (none)
   \end{itemize}

   \noindent
   Note that since this target has the potential to delete much more than
   was possibly desired by the programmer it is advisable to do a dry run
   using

\begin{verbatim}
   gmake -n cleanest
\end{verbatim}

   \noindent
   before using it.

\item
   \file{\%.lcc} : (specific, pattern rule)
   \\ Preprocess a \file{.l} file using \code{\$(LEX)} and leave the resulting
   \file{.lcc} file in \file{\$(PGMRINCD)}.
   \begin{itemize}
   \item
      \file{imp}: Preprocess the \file{.l} file associated (probably) with a
      class implementation.
   \end{itemize}

\item
   \file{\%.ycc} : (specific, pattern rule)
   \\ Preprocess a \file{.y} file using \code{\$(BISON)} and leave the
   resulting \file{.ycc} file in \file{\$(PGMRINCD)}.
   \begin{itemize}
   \item
      \file{imp}: Preprocess the \file{.y} file associated (probably) with a
      class implementation.
   \end{itemize}

\item
   \file{\%.d} : (specific, pattern rule)
   \\ List the dependencies of a source file.  A side effect of this is to
   update the dependency list for the particular source file if necessary.
   The contents of the programmer dependency list may differ from that for a
   system compilation of the same source file if the programmer has private
   versions of the source file or any of the relevant header files.
   \begin{itemize}
   \item
      \file{app}: List the dependencies of an application.
   \item
      \file{imp}: List the dependencies of a class implementation file.
   \item
      \file{tst}: List the dependencies of a test program.
   \end{itemize}

\item
   \file{\%.i} : (specific, pattern rule)
   \\ Apply the \code{C} preprocessor \code{\$(CPP)} to a source file in the
   current directory or \file{\$(CODEDIR)} and put the resulting \file{.i}
   file in \file{\$(PGMRLIBD)}.
   \begin{itemize}
   \item
      \file{app}: Preprocess the \file{.cc} file for an application.  The
      include path will be augmented with current directory (i.e. \code{-I.})
      and of the corresponding system directory, \file{\$(CODEDIR)}, in that
      order.  This allows applications to maintain their own include files.
   \item
      \file{imp}: Preprocess the \file{.cc} file for a class implementation.
   \item
      \file{tst}: Preprocess the \file{.cc} file for a test program.  The
      include path will be augmented with current directory (i.e. \code{-I.})
      and of the corresponding system directory, \file{\$(CODEDIR)}, in that
      order.  This allows test programs to maintain their own include files.
   \end{itemize}

\item
   \file{\%.o} : (specific, pattern rule)
   \\ Produce an object module from the corresponding source file in the
   current directory or \file{\$(CODEDIR)} and put it in \file{\$(PGMRLIBD)}.
   Debug compilations are done by default, but optimized compilations can be
   selected via the \code{OPT} variable or alternate programmer compilation
   flags (see \ref{Code development makedefs conventions}).
   \begin{itemize}
   \item
      \file{app}: Compile the \file{.cc} file for an application into an
      object module and put it in \file{\$(PGMRLIBD)}.  The include path is
      augmented with current directory (i.e. \code{-I.}) and of the
      corresponding system directory, \file{\$(CODEDIR)}, in that order.  This
      allows applications to maintain their own include files.
   \item
      \file{ftn}: Compile the \file{.f} file for a \textsc{fortran} subroutine
      into an object module and put it in \file{\$(PGMRLIBD)}.
   \item
      \file{imp}: Compile the \file{.cc} file for a \cplusplus\ class
      implementation into an object module and put it in \file{\$(PGMRLIBD)}.
   \item
      \file{ins}: Compile the \file{.c} file for a utility program into an
      object module and leave it in the current directory.
   \item
      \file{tst}: Compile the \file{.cc} file for a test program into an
      object module and put it in \file{\$(PGMRLIBD)}.  The include path is
      augmented with current directory (i.e. \code{-I.}) and of the
      corresponding system directory, \file{\$(CODEDIR)}, in that order.  This
      allows test programs to maintain their own include files.
   \end{itemize}

\item
   \code{mylib(\%.o)} : (specific, pattern rule)
   \\ Compile an object module using the \file{\%.o} pattern rule and insert it
   into a private library in \file{\$(PGMRLIBD)}, then apply \code{\$(RANLIB)}
   to the library.
   \begin{itemize}
   \item
      \file{ftn}: Compile the \file{.f} file for a \textsc{fortran} subroutine
      and insert it into a private \textsc{fortran} library.
   \item
      \file{imp}: Compile the \file{.cc} file for a \cplusplus\ class
      implementation and insert it into a private \cplusplus\ library.
   \end{itemize}

\item
   \code{\%} : (specific, catch-all pattern rule or static pattern rule)
   \\ Compile an object module or executable.
   \begin{itemize}
   \item
      \file{app}: Catch-all pattern rule to compile an executable.  Debug
      compilations are done by default, but optimized compilations can be
      selected via the \code{OPT} variable or alternate programmer compilation
      flags (see \filref{makedefs}).

      The include path will be augmented with current directory (i.e.
      \code{-I.}) and of the corresponding system directory,
      \file{\$(CODEDIR)}, in that order.  This allows an application to
      maintain a set of include files specific to it.

      The executable will be linked against the library list specified by
      \code{\$(PGMRLIBS)} in which private programmer libraries are listed
      before system libraries (see above).

      The executable will be left in \file{\$(PGMRBIND)}.
   \item
      \file{doc}:  Catch-all pattern rule to invoke \unixexe{latex2html} on
      the corresponding \file{.latex} source file.
   \item
      \file{ftn}:  Catch-all pattern rule to compile a \textsc{fortran}
      subroutine if the corresponding library module is out-of-date.  The
      resultant object module is left in the \file{\$(PGMRLIBD)} directory and
      is not inserted into the library.  Refer to the entry for the \file{imp}
      makefile.
   \item
      \file{imp}:  Catch-all pattern rule to compile a class implementation if
      the corresponding library module is out-of-date.  The resultant object
      module is left in the \file{\$(PGMRLIBD)} directory and is not inserted
      into the library.

      This rule may be used in conjunction with \code{update\_mylib} to update
      several library modules in one invokation of \exeref{gmake} without
      updating the library for each one.  For example,

\begin{verbatim}
   gmake Bloggs Boggle update_mylib
\end{verbatim}

      \noindent
      Note that this is not the same as

\begin{verbatim}
   gmake Bloggs.o Boggle.o update_mylib
\end{verbatim}

      \noindent
      Which may cause the object modules to be compiled even if the library
      modules are up-to-date with respect to their sources.
   \item
      \file{ins}: Static pattern rule on \file{\$(ALLEXES)} to compile a
      utility program leaving the executable in the current directory.
   \item
      \file{tst}: Catch-all pattern rule to compile an executable.  Debug
      compilations are done by default, but optimized compilations can be
      selected via the \code{OPT} variable or alternate programmer compilation
      flags (see \filref{makedefs}).

      The executable will be linked against the library list specified by
      \code{\$(PGMRLIBS)} in which private programmer libraries are listed
      before system libraries (see above).

      The executable will be left in \file{\$(PGMRBIND)}.
   \end{itemize}

\item
   \code{depend} : (specific)
   \\ Determine dependencies for all sources in the current directory.
   \begin{itemize}
   \item
      \file{app}: Determine dependencies for the application.
   \item
      \file{aps}: Determine dependencies for all applications which have their
      main \file{.cc} file in the programmer's workspace, \file{\$(PGMREXES)}.
   \item
      \file{imp}: Determine dependencies for all class implementations with
      sources in the current directory, \file{\$(PGMRIMPS)}.
   \item
      \file{tst}: Determine dependencies for all test programs with sources in
      the current directory, \file{\$(PGMREXES)}.
   \end{itemize}

\item
   \code{dependencies} : (specific, recursive)
   \\ Determine dependencies for all sources in the current directory and in
   \file{\$(CODEDIR)}.
   \begin{itemize}
   \item
      \file{aps}: Determine programmer dependencies for all programmer and
      system applications in this package, \file{\$(ALLEXES)}.  This comprises
      all applications which have their main \file{.cc} file in the
      programmer's workspace, \file{\$(PGMREXES)}, and in the corresponding
      system directory, \file{\$(AIPSEXES)}.
   \item
      \file{imp}: Determine dependencies for all class implementations in the
      current directory and in \file{\$(CODEDIR)} and likewise for all
      subdirectories.
   \item
      \file{tst}: Determine dependencies for all test programs in the current
      directory and in \file{\$(CODEDIR)}.
   \end{itemize}

\item
   \code{exorcise} : (specific)
   \\ Delete stale entries from dependency lists and programmer libraries
   after a source file has been removed from the current directory (e.g. via
   checkin).  Recurses into any \file{tmplinst} subdirectory to do the same
   thing there.
   \begin{itemize}
   \item
      \file{app}: Cleans up the dependency list and programmer library for the
      application.
   \item
      \file{imp}: Cleans up the dependency list for the software module and
      the programmer library for the package.
   \item
      \file{tst}: Cleans up the dependency list and programmer library for the
      test program.
   \end{itemize}

\item
   \code{mylib} : (specific)
   \\ Compile all sources in the current directory and in \file{\$(CODEDIR)} to
   build a complete private object library.
   \begin{itemize}
   \item
      \file{app}: Instantiate do-it-yourself templates (see \exeref{mkinst}).
      If a semaphore file called \file{MyTemplatesOnly} exists in the
      programmer's directory then system templates will be excluded from the
      compilation.
   \item
      \file{ftn}: Build a private \textsc{fortran} library.
   \item
      \file{imp}: Build a private \cplusplus\ library.
   \item
      \file{tst}: Instantiate do-it-yourself templates (see \exeref{mkinst}).
      If a semaphore file called \file{MyTemplatesOnly} exists in the
      programmer's directory then system templates will be excluded from the
      compilation.
   \end{itemize}

\item
   \code{mylibs} : (specific)
   \\ Invoke the \code{mylib} rule in the current directory and all
   subdirectories.
   \begin{itemize}
   \item
      \file{ftn}: Invoke \code{mylib} in the current directory and all
      subdirectories.
   \item
      \file{imp}: Invoke \code{mylib} in the current directory and all
      subdirectories.
   \end{itemize}

\item
   \file{tmplinst} : (specific)
   \\ Invoke \exeref{mkinst} to generate do-it-yourself template instantiation
   files.  If there is no \file{templates} file in the current directory then
   \exe{mkinst} is invoked with input from \file{/dev/null} in order to delete
   any stale template instantiation files.
   \begin{itemize}
   \item
      \file{app}: Generate do-it-yourself template instantiation files for an
      application.
   \item
      \file{imp}: Generate do-it-yourself template instantiation files for a
      class implementation module.
   \item
      \file{tst}: Generate do-it-yourself template instantiation files for an
      test program.
   \end{itemize}

\item
   \file{inst} : (specific)
   \\ Invoke the \code{tmplinst} rule to generate do-it-yourself template
   instantiation files and then invoke the \code{mylib} rule in the
   \file{tmplinst} subdirectory to compile and insert them into an object
   library.
   \begin{itemize}
   \item
      \file{app}: Generate and compile do-it-yourself templates for an
      application.
   \item
      \file{imp}: Generate and compile do-it-yourself templates for a
      class implementation module.
   \item
      \file{tst}: Generate and compile do-it-yourself templates for a
      test program(s).
   \end{itemize}

\item
   \code{update\_mylib} : (specific)
   \\ Insert all object modules into a private library and then apply
   \code{\$(RANLIB)} to it.  The object modules and library reside in
   \file{\$(PGMRLIBD)}.  The object modules are deleted after the library
   has been updated.
   \begin{itemize}
   \item
      \file{app}: Update a private object library associated with an
      application.
   \item
      \file{ftn}: Update a private \textsc{fortran} library.
   \item
      \file{imp}: Update a private \cplusplus\ library.
   \item
      \file{tst}: Update a private object library associated with a test
      program.
   \end{itemize}

\item
   \file{\%.dvi} : (specific, pattern rule)
   \\ Compile a \file{.dvi} file.
   \begin{itemize}
   \item
      \file{doc}: Compile the \file{.dvi} file from the \file{.texi},
      \file{.latex}, or \file{.tex} file (in that order of preference) in the
      current directory or \file{\$(CODEDIR)} and leave it in the current
      directory.

      Included files will be searched for in the corresponding \file{.dir}
      subdirectory of the current directory and of \file{\$(CODEDIR)} in that
      order.  Any \LaTeX-related \file{.bib} bibliography files
      contained in these directories will be processed by \textsc{Bib}\TeX.
   \end{itemize}

\item
   \file{\%.ps} : (specific, pattern rule)
   \\ Compile a \file{.ps} \textsc{PostScript} file.
   \begin{itemize}
   \item
      \file{doc}: Compile a \file{.ps} \textsc{PostScript} file from the
      corresponding \file{.dvi} file in the current directory.  If necessary
      the \file{.dvi} file will be generated automatically by \exeref{gmake}
      by rule-chaining the \file{\%.dvi} pattern rule.
   \end{itemize}

\item
   \code{doc} : (specific)
   \\ Compile all printable documents.
   \begin{itemize}
   \item
      \file{doc}: Compile all \file{*.texi}, \file{*.latex} and \file{*.tex}
      files in the current directory into \file{*.ps} \textsc{PostScript} files
      and leave them in the current directory.
   \end{itemize}
\end{itemize}

\subsection*{Notes}

\begin{itemize}
\item
   The implement makefile includes the system dependency lists and so may
   start slowly as it checks to see whether the list is up-to-date (regardless
   of whether the particular target uses it or not).  Inclusion of the
   dependency list can be circumvented by setting the \code{NODEP} variable
   (to anything).  This causes the makefile to start considerably faster.

   \code{NODEP} is set automatically if \exeref{gmake} is invoked from a
   directory which does not reside under \file{\$AIPSROOT}, that is, a
   programmer invokation.  However, system-oriented targets may also be
   invoked from a programmer directory, and this would cause the dependency
   analysis to be circumvented, and the dependency list to be ignored.  This
   may be legitimate if the target invoked does not actually use the
   dependency list, for example \code{chkout}, \code{cleancode} or
   \code{cleansys}.  In fact, the code distribution system sets \code{NODEP}
   explicitly when it invokes the top-level makefile for these recursive
   targets for the system (\exeref{inhale}).  However, \code{NODEP} must not
   be set for an invokation of the implement makefile for a target which does
   use the dependency list.  A proper resolution of this problem would require
   the facility for a makefile to examine its target list, but this is not
   currently possible.

\item
   If the \aipspp\ \rcs\ source code repositories are present in an
   installation all \aipspp\ makefiles access them via a symbolic link
   \file{\$AIPSROOT/rcs} which is usually set to point to \file{slave}.
   Therefore, the slave \rcs\ repositories are normally the ones consulted.
   However, it is possible to reset the \file{rcs} ``switch'' to \file{master}
   to cause \exeref{gmake} to checkout and/or rebuild \aipspp\ from the
   \file{master} repositories.  \exeref{exhale} uses this mechanism when
   constructing a new base release.  However, it requires good bandwidth to
   the master and is only feasible in Socorro.
\end{itemize}

\subsection*{Examples}

The \code{mylib} target for the implement makefile rebuilds a programmer's
private library in its entirety, including all object modules generated from
sources in \file{\$(CODEDIR)}.  To rebuild only the modules with sources in the
programmer's directory the following would suffice:

\begin{verbatim}
   cd $HOME/aips++/code/aips/implement
   gmake
\end{verbatim}

\noindent
This is the recommended way of updating a private libarary.

\subsection*{See also}

The \textsc{gnu} \code{Make} manual.\\
The \textsc{gnu} manual page for \unixexe{gmake}.\\
The unix manual page for \unixexe{ranlib}(1).\\
\aipspp\ variable names (\sref{variables}).\\
\exeref{gmake}, \textsc{gnu} make.\\
\filref{makedefs}, \aipspp\ makefile definitions.\\
\exeref{mkinst}, Generate template instantiation files from a list.\\
\exeref{updatelib}, update an \aipspp\ object library.

% ----------------------------------------------------------------------------

\newpage
\section{\exe{depstat}}
\label{depstat}
\index{depstat@\exe{depstat}}
\index{include files!usage statistics|see{\exe{depstat}}}

Count the number of header files used by \aipspp\ class implementation files.

\subsection*{Synopsis}

\begin{synopsis}
   \code{\exe{depstat} [dependency list]}
\end{synopsis}

\subsection*{Description}

\exe{depstat} is a \unixexe{sed}/\unixexe{awk} filter which reads a dependency
list and counts the number of \aipspp\ header files on which each \aipspp\ 
implementation file depends.

System dependency lists have names of the form \file{*.list} and reside in the
\code{\$(ARCHAUXD)} directory.  Programmer dependency lists reside in
\code{\$(PGMRAUXD)} if that exists, otherwise they are left with the
programmer's source code.  Refer to \sref{Code development makefile rules} and
\sref{Code development makedefs conventions}.

If no dependency list is specified on the command line, input is taken from
\file{stdin}.

\subsection*{Options}

None.

\subsection*{Examples}

\begin{verbatim}
\end{verbatim}

\subsection*{See also}

\aipspp\ variable names (\sref{variables}).\\
Section \sref{Code development makedefs conventions}, Code development
   \file{makedefs} conventions.\\
Section \sref{Code development makefile rules}, Code development makefile
   rules.\\

\subsection*{Author}

Original: 1994/02/10 by Mark Calabretta, ATNF

% ----------------------------------------------------------------------------

\newpage
\section{\exe{ldmap}}
\label{ldmap}
\index{ldmap@\exe{ldmap}}
\index{nm@\unixexe{nm}|see{\exe{ldmap}}}
\index{namelist, analysis|see{\exe{ldmap}}}
\index{code!development!dependency analysis|see{\exe{ldmap}}}
\index{dependency analysis!namelist analyser|see{\exe{ldmap}}}

Determine dependencies between object modules from a namelist.

\subsection*{Synopsis}

\begin{synopsis}
   \code{\exe{ldmap} \\
      \ \ \ [\exe{-1}] \\
      \ \ \ [\exe{-h} \#] \\
      \ \ \ [\exe{-m} | \exe{-M}] \\
      \ \ \ [\exe{-o} | \exe{-O} object] \\
      \ \ \ [\exe{-r}] \\
      \ \ \ [\exe{-s} file | directory] \\
      \ \ \ [\exe{-t}] \\
      \ \ \ [namelist [namelist \ldots]]}
\end{synopsis}

\subsection*{Description}

\exe{ldmap} reads through a file containing the output produced by
\unixexe{nm} and determines the dependency hierarchy of \file{.o} files.  That
is, if \code{X} is an undefined symbol in \file{a.o}, and \code{X} is defined
in \file{b.o}, then \file{a.o} depends on \file{b.o}.

There is also an option to reverse the dependency analysis so that instead of
listing all the object modules {\em required by} a particular object module
\exe{ldmap} lists all of the object modules {\em which require} a particular
object module.

The name list file may be specified as ``\file{-}'' whence \exe{ldmap} will
read it from \file{stdin}.

The analysis is done in two stages.  First the namelist is converted to a list
of dependencies of the form

\begin{verbatim}
   a.o b.o
\end{verbatim}

\noindent
meaning that \file{a.o} requires \file{b.o}.  If the \exe{-m} option is
specified the output looks like

\begin{verbatim}
   a.o usym b.o
\end{verbatim}

\noindent
where \code{usym} is the undefined symbol in \file{a.o} which would cause the
linker to load \file{b.o}.  If the \exe{-M} option is specified the output
also includes lines such as

\begin{verbatim}
   a.o dsym a.o
\end{verbatim}

\noindent
where \code{dsym} is a symbol defined in \file{a.o}.

Unresolved symbols may be included in the output via the \exe{-n} option:

\begin{verbatim}
   a.o (usym)
\end{verbatim}

\noindent
The stage~2 analysis consists of iterating through the dependency list to find
all object modules required by each particular object module.  By default, all
object modules in the dependency list are processed, however the analysis may
be done for a set of object modules via the \exe{-o} option.

Since the stage~1 analysis is time-consuming, the intermediate results can be
saved for later use in either or both of two forms.  In packed form, the
stage~1 results are stored in a single file.  In the unpacked form, which is
the most efficient for the stage~2 analysis, the results for each object
module are stored in a separate file in a subdirectory.

\subsection*{Options}

\begin{description}
\item[\exe{-1}]
   Quit after the stage~1 analysis.

\item[\code{\exe{-h} \#}]
   Set a limit to the depth of the dependency hierarchy in the stage~2
   analysis.

\item[\code{\exe{-m} | \exe{M}}]
   Produce a stage~1 analysis with more information than is needed for
   stage~2.

   \exe{-m} includes symbol names in the output of the stage~1 analysis, and
   \exe{-M} also includes symbols defined in each object module.

   The \exe{-m} and \exe{-M} options are meant to be used with the \exe{-p}
   option to produce a file for visual inspection.  The extra information is
   thrown away when the stage~1 analysis is unpacked.

\item[\exe{-n}]
   Include unresolved symbols in the stage~1 analysis.  They appear in the
   stage~1 output in parentheses.

\item[\code{\exe{-o} object | \exe{-O} object}]
   Determine dependencies for the specified object module only.  Multiple
   object modules may be specified in a single \exe{-o}, or multiple \exe{-o}
   options may be specified.  Either way the analysis is performed for the
   group as a whole.

   If \exe{-O} is specified the stage~1 analysis will be unpacked, otherwise
   the packed analysis will be used unless the unpacked analysis is already
   available.

\item[\code{\exe{-p} file | \exe{-P} directory}]
   Preserve the result of the stage~1 analysis.

   \exe{-p} saves the packed result in the specified file.

   \exe{-P} saves the unpacked result in the specified directory.

   If the file and/or directory already exist they will be deleted.  Both
   options may be specified together.

\item[\exe{-r}]
   Reverse the direction of the dependency analysis.  In the stage~1 analysis
   the namelist is converted to a list of dependencies of the form

   \begin{verbatim}
      a.o b.o
   \end{verbatim}

   \noindent
   meaning that \file{a.o} is required by \file{b.o}.  The stage~2 analysis is
   unaffected.  Use of the \exe{-r} option precludes the use of the \exe{-n}
   and \exe{-v} options.

\item[\code{\exe{-s} file | \exe{-S} directory}]
   Skip stage~1 of the analysis.

   \exe{-s} specifies the name of a file containing the stage~1 analysis from
   a previous invokation of \code{ldmap -p}, or the name of a directory
   containing the unpacked stage~1 analysis from a previous invokation of
   \code{ldmap -P}.

   In either case the namefile need not be specified.

   A \exe{-s} option may not be combined with stage~1 analysis options except
   for the combination \code{-s <file> -P <directory>}.

\item[\exe{-t}]
   Print timing information.

\item[\code{\exe{-v} file}]
   A file containing the output of \code{ar tv} used for determining sizes.
   Multiple \exe{-v} options may be specified.
\end{description}

\subsection*{Notes}

\begin{itemize}
\item
   \exe{ldmap} assumes the namelist is in a form similar to that produced by
   the \unixexe{nm} provided with SunOS 5.5.  Other versions of \unixexe{nm},
   even those in earlier versions of SunOS, may produce namelists in an
   incompatible format.

\item
   The output of ldmap may be piped through \unixexe{c++filt} to demangle
   \cplusplus\ names.
\end{itemize}

\subsection*{Diagnostics}

Status return values
\\ \verb+   0+: success
\\ \verb+   1+: initialization error

\subsection*{Examples}

The following determines all dependencies for the \code{gtable} application.

\begin{verbatim}
   cd $HOME/aips++/code/aips/apps/gtable/
   gmake gtable.o
   cd $HOME/aips++/sun4sol_gnu/bindbg
   nm gtable.o > gtable.nm
   nm /aips++/sun4sol_gnu/lib/libaips.a > libaips.nm
   ldmap -n -o gtable.o gtable.nm libaips.nm
\end{verbatim}

\noindent
This produces output such as

\begin{verbatim}
   gtable.o
      Error2.o
      Excp2.o
      GlishArray.o
      GlishEvent.o
      GlishRecord.o
      String.o
         ArrayPosIter.o
         Array_1020.o
         Array_1030.o
         Array_1050.o
         .
         .
         .
               StreamLogSink.o
               SymLink.o
               Time.o
                  ByteIO.o
                  ObjectID.o
                     Vector_1100.o
                        VectorRtti_1180.o
Count: 235
\end{verbatim}

\noindent
The levels of indentation are indicative of each cycle of the recursion.  Note
that the above list contains object modules derived from do-it-yourself
template instantiation (see \exeref{mkinst}).

Using \file{libaips.nm} generated above, the following saves a reversed
stage~1 analysis of \file{libaips.a} in unpacked form for later use and then
quits.

\begin{verbatim}
   ldmap -1 -P libaips.1ru -r libaips.nm
\end{verbatim}

\noindent
With most of the hard work done, the saved stage~1 analysis may then be used
repeatedly to quickly determine all object modules in \file{libaips.a} which
depend on (i.e. contain symbols resolved by) a specified module.  For example
\file{DeconvTool.o}

\begin{verbatim}
   ldmap -s libaips.1ru -o DeconvTool.o
\end{verbatim}

\noindent
resulting in the following (unusually brief) output:

\begin{verbatim}
   DeconvTool.o
      CCleanTool.o
      CleanTool.o
      FTCleanTool.o
         HCleanTool.o
         SDICleanTool.o
   Count: 6
\end{verbatim}

\subsection*{See also}

The unix manual page for \unixexe{nm}(1).\\
\exeref{mkinst}, Generate template instantiation files from a list.

\subsection*{Author}

Original: 1996/05/06 by Mark Calabretta, ATNF.

% ----------------------------------------------------------------------------

\newpage
\section{Template management}
\label{templatemgmt}
\index{templatemgmt@\exe{templatemgmt}}
\index{template files!template management |see{\exe{templatemgmt}}}

% ----------------------------------------------------------------------------

\subsection{\exe{reident}}
\label{reident}
\index{reident@\exe{reident}}
\index{templates!list!reformat|see{\exe{reident}}}

Remake the idents in a templates list.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{reident} [\exe{-z}] [\exe{-t}] [file [file \ldots]]}
\end{synopsis}

\subsubsection*{Description}

\exe{reident} reads a template file (\file{templates} by default, see
\exeref{mkinst}), sort/uniqs it on the name of the class implementation
\file{.cc} file (second field), and replaces the idents on some or all lines
so that each combination of ident and \file{.cc} file is unique.

\noindent \exe{reident} also converts each entry in the input to a canonical
form with respect to the use of spacing and \code{typedef}'d variables so
that trivial duplications are automatically eliminated, and it warns of any
non-trivial deviation from the canonical forms.

\noindent \exe{reident} does not check for duplicate template definitions. The
\exeref{duplicates} program is available for that purpose.

\noindent \exe{reident} also converts each entry in the input to a formatted
multi-line output that can be read by \exeref{mkinst}.

If multiple files are specified they will be merged together.  One file may
be specified as ``\file{-}'' to denote input from \file{stdin}.  Output is
written to \file{templates} or to \file{stdout} -- if the input came from
\file{templates} it will be overwritten.

Missing idents (the preferred way of adding template definitions), 
idents specified as less than \code{1000} (another safe way to add new
templates) and the second and subsequent occurrence of
duplicate idents are replaced by a unique value for each \file{.cc} file.  If
the \exe{-z} option is specified, all idents are replaced with an ascending
sequence starting at \code{1000} for each \file{.cc} file.

The idents are incremented by \code{10} to allow manual insertion of new
template declarations in the correct sequence.

Comments in the templates file (lines beginning with ``\code{\#}'') will
either stay at the top of the file, or stay tuned to the template definition
line(s) they occur at.

\subsubsection*{Options}

\begin{description}
\item[\exe{-z}]
   Replace all idents with an ascending sequence restarting at \code{1000} for
   each \file{.cc} file.
\item[\exe{-t}]
   Write the output to the terminal (\file{stdout}) in stead of
   \file{./templates}. 
\end{description}

\subsubsection*{Notes}

\begin{itemize}
\item
    Changing the ident for a template declaration invalidates any pre-existing
    template instantiation \file{.cc} file for that template.  However, since
    the idents restart for each class implementation \file{.cc} file, ident
    changes will be quarantined to the templates based on it.
\end{itemize}

\subsubsection*{Diagnostics}

Status return values
\\ \verb+   0+: success
\\ \verb+   1+: file not found

\subsubsection*{Examples}

To merge a private templates list into the system's list for the \code{aips}
package and at the same time completely refresh the idents

\begin{verbatim}
   cd $HOME/aips++/code/aips/implement/_ReposFiller
   ao -l templates
   reident -z templates myTemplates
   ai templates
\end{verbatim}

To check a newly created templates list and check it for duplicates
internally and against the trial repository:

\begin{verbatim}
    reident -t | duplicates -r trial -
\end{verbatim}



\noindent
If seldom used the \exe{-z} option has the potential to cause a great deal of
recompilation because of accumulated changes.  However, if used regularly the
incremental cost should be modest. Also, all care should be taken that
templates included are not duplicated (see \exeref{duplicates}).

\subsubsection*{See also}

\exeref{mkinst}, Generate template instantiation files from a list.\\
\exeref{duplicates}, Checks for duplicate entries in \file{templates} lists
   across the system.\\
\exeref{unused}, Checks for usage of templates in binary modules (executables
or object modules).\\
\exeref{used}, find any undefined classes and global methods.

\subsubsection*{Author}

Original: 1996/04/16 by Mark Calabretta, ATNF.

% ----------------------------------------------------------------------------

\newpage
\subsection{\exe{duplicates}}
\label{duplicates}
\index{duplicates@\exe{duplicates}}
\index{template files!duplicate template instantiations|see{\exe{duplicates}}}

Look for duplicate entries in \aipspp\ \code{templates} instantiation files

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{duplicates} [\exe{-p} \exe{package}|\exe{all}] [\exe{-r}
   \exe{package}|\exe{all}]  [\exe{-u} \exe{package}|\exe{all}] \ldots\ 
   [templates file] \ldots}
\end{synopsis}

\subsubsection*{Description}

\exe{duplicates} is a \code{C++} executable program which looks for duplicate
entries in \aipspp\ \code{templates} files. This is useful for finding
redundant templates entries, and for moving duplicate entries into a common
\code{templates} file.

One entry in the \code{template file list} may be specified as \code{-} to
indicate standard input.

If no list of files is provided, the list used is the combination of:
\begin{enumerate}
        \item A file named \code{templates} in the current working directory
              if any; and
        \item All files named \code{templates} under the
             \code{\$AIPSCODE} tree, unless switches restrict the search to
              specified packages and/or repositories and/or non-repositories.
\end{enumerate}

Duplicates found in the first (or the default templates file) are indicated
by asterisks next to the line number.

The output can be restricted to duplicates that are only present in a package
repository file and/or in a single file.

\subsubsection*{Options}

Options are provided to limit the number of templates files that will be
included in the search. Check with:

\begin{verbatim}
   duplicates -h
\end{verbatim}

to find the currently available switches.

\begin{description}
\item[\code{\exe{-h}}]
    Give some useage information
\item[\code{\exe{-s}}]
    Restrict the output ('s' for 'system') to duplicates found in a single
    file or in \code{\_ReposFiller} files.
\item[\code{\exe{-p} \exe{package}|\exe{all}}]
    Restrict tests to templates files in the specified package (or all
    packages)
\item[\code{\exe{-r} \exe{package}|\exe{all}}]
    Restrict tests to the repository templates files in the specified package
    (or all packages)
\item[\code{\exe{-u} \exe{package}|\exe{all}}]
    Restrict tests to the non-repository templates files in the specified package
    (or all packages)
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
   duplicates
   duplicates templates /aips++/code/aips/implement/_ReposFiller/templates
   reident -t | duplicates -r trial - 
\end{verbatim}

The first line finds all duplicates in \code{./templates} and all templates
files checked into the system. The second example finds duplicates only in
the listed files. The third line reformats and checks \code{./templates}, and
then checks for duplicates in this file and in \\
\file{trial/implement/\_ReposFiller/templates}.

\subsubsection*{See also}

\aipspp\ do-it-yourself template instantiation (\exeref{mkinst}).\\
\exeref{reident}, reformat in canonical form the template instantiation file.\\
\exeref{unused}, check usage of templates in binary executables and object
modules.\\
\exeref{used}, find any undefined classes and global methods.

\subsubsection*{Author}

Original: 1997/06/09 by Brian Glendenning, NRAO

% ----------------------------------------------------------------------------

\newpage
\subsection{\exe{unused}}
\label{unused}
\index{unused@\exe{unused}}
\index{templates!list!reformat|see{\exe{unused}}}

Check for unused (or used) template object modules in binaries and/or object
modules and/or libraries.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{unused} [\exe{-z}|\exe{-nz}|\exe{-a}|\exe{-[0-9]\ldots}]
        [\exe{-p}|\exe{-r}|\exe{-u} package] \ldots\  
        [-t templates1 [templates2 \ldots]]
        \exe{-f}|\exe{-b} file1 [file2 \ldots] 
        [\exe{-i} list1 [list2 \dots]]}
\end{synopsis}

\subsubsection*{Description}

\exe{unused} reads binary files (either executables, object modules or object
libraries) specified by the \exe{-b} switch or the output of the
\exe{g++filt} filtered output of the \exe{nm} or \exe{gnm} 
program of such files as specified by the \exe{-f} switch. I.e. files that
are to be specified following an \exe{-f} switch should have the following
pre-processing: 
\begin{verbatim}
        [g]nm binary.file | g++filt >! file.f
\end{verbatim}
(Note that internally \exe{unused} uses the \exe{gnm} and \exe{g++filt}
synonyms. If they are not available on your system, the full path of these
programs (or for the \exe{nm} program) can be specified in the \code{aipsrc}
file variables \code{unused.file.nm} and \code{unused.file.gfilt}.)

The other part of the input is a set of templates files. They can be
specified as individual templates files (following the \exe{-t} switch), or as
a set of templates files in a package (like \exe{aips}, \exe{trial} or
\exe{all} to indicate all packages).

The templates in the specified templates files (including those specified
with the \exe{-i} switch) will be checked against the
templates defined in the binary files . Depending on the show switches (\exe{-a}, \exe{-z},
\exe{-nz}, \exe{-number}) the output will contain templates used or unused in
the specified binary files.

\subsubsection*{Options}

\begin{description}
\item[\exe{-z}]
   Show the unused templates only (this is the default if no show switch is
   given)
\item[\exe{-nz}]
   Show the used templates only (if the output is saved to a file, it can be
   used in a subsequent run of the \exe{unused} program with the \exe{-i}
   switch in stead of the original binary files)
\item[\exe{-a}]
   Show all the templates used in the binaries (i.e. both the used and unused
   ones)
\item[\exe{-number}]
   Show only the templates that are used in at least the number of binary
   files specified. I.e. if the switch given is \exe{-2}, and two binary
   files are given as input, only templates occurring in both of these will
   be shown. If only one binary file was given nothing will be shown; if
   three binary files were specified all templates used in at least two of
   them will be shown.
\item[\exe{-p package}]
   Use all templates files found in the specified package (the package name
   may be ``all'')
\item[\exe{-r package}]
   Use all templates files in the repository directory of the specified
   package (or ``all'')
\item[\exe{-u package}]
   Use all user templates files in the package (i.e. excluding the ones in
   the repositories)
\item[\exe{-t file [file \ldots]}]
   Use the explicitly specified templates files
\item[\exe{-i file [file \ldots]}]
   Use the specified files as a source of templates. The files must be the
   ouput of an earlier run of the unused program (e.g. with the \exe{-nz}
   switch).
\item[\exe{-b|-f file [file \ldots]}]
   Specify the binary files (\exe{-b}) to be checked. The files can be
   executables, object libraries or object modules (i.e. files that can be
   handled by some \exe{nm} program). If the \exe{-f} switch is used in stead
   of the \exe{-b} switch, the binary files are supposed to have been
   filtered already by a \exe{nm} program and the \exe{g++filt} program.
\end{description}

\subsubsection*{Notes}

\begin{itemize}
\item
   The output of the program can be used as input to the \exeref{duplicates}
   program. 
\end{itemize}

\subsubsection*{Diagnostics}

Status return values
\\ \verb+   0+: success
\\ \verb+   1+: no files found

\subsubsection*{Examples}

To show all the templates specified in the \code{Tables/test/templates} file
that are used in a demonstration program \exe{dM30}:

\begin{verbatim}
   unused -a ~/aips++/sun4sol_gnu/bindbg/dM30 -b `which dM30`

Using [/aips++/code/aips/implement/Tables/test/templates]
176 templates in 1 files
176 templates in 1 files after 0 inclusion files
Checked against 11259 names in 1 name files
# Template usage: 
    0: AiPs_hidden_type_(Array<ExampleDesc> *)
    0: AiPs_hidden_type_(Array<RetypedArrayEx1> *)
    0: AiPs_hidden_type_(Array<RetypedArrayEx2> *)
    0: AiPs_hidden_type_(Array<VSCExample> *)
.......
    0: valDataTypeId(RetypedArrayEx2 const *)
    0: valDataTypeId(VSCExample const *)
176 templates shown
\end{verbatim}

In this case all the templates in the templates file have a count zero (none
used in the binary). The same output would have been generated with the
(default) \exe{-z} switch, while no templates would have been shown if the
\exe{-nz} switch had been used.


\subsubsection*{See also}

\exeref{mkinst}, Generate template instantiation files from a list.\\
\exeref{duplicates}, Checks for duplicate entries in \file{templates} lists
   across the system.

\subsubsection*{Author}

Original: 1997/07/16 by Wim Brouw, ATNF.

% ----------------------------------------------------------------------------

\newpage
\subsection{\exe{used}}
\label{used}
\index{used@\exe{used}}
\index{templates!list!reformat|see{\exe{used}}}

Check for undefined classes and global functions in object libraries and
object modules.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{used} [\exe{-ng}] [\exe{-nc}] [\exe{-tc}]
        [[\exe{-f}|\exe{-b}] file1 [file2 \ldots]] \ldots }
\end{synopsis}

\subsubsection*{Description}

\exe{used} reads binary files (either object modules or object
libraries) specified by the \exe{-b} switch (default) and/or the output of the
\exe{g++filt} filtered output of the \exe{nm} or \exe{gnm} 
program of such files if specified by the \exe{-f} switch. I.e. files that
are to be specified following an \exe{-f} switch should have the following
pre-processing: 
\begin{verbatim}
        [g]nm binary.file | g++filt >! file.f
\end{verbatim}
(Note that internally \exe{used} uses the \exe{gnm} and \exe{g++filt}
synonyms. If they are not available on your system, the full path of these
programs (or for the \exe{nm} program) can be specified in the \code{aipsrc}
file variables \code{unused.file.nm} and \code{unused.file.gfilt}.)

The first file specified is checked for any undefined global names. These
undefined names are then checked against any definitions in all files
given. Finally the resulted list of undefined names is output to stdout.
The standard checking is for all global names. The \exe{-ng} \exe{-nc} and
\exe{-tc} switches can be used to limit the output.

\subsubsection*{Options}

\begin{description}
\item[\exe{-nc}]
   Show no classes (i.e. only the global functions)
\item[\exe{-ng}]
   Show no global functions (i.e. only classes)
\item[\exe{-tc}]
   Show for classes only templated classes
\item[\exe{-b|-f file [file \ldots]}]
   Specify the binary files (\exe{-b}), also the default, to be checked. The
   files can be executables, object libraries or object modules (i.e. files
   that can be handled by some \exe{nm} program). If the \exe{-f} switch is
   used in stead of the (default) \exe{-b} switch, the binary files are
   supposed to have been filtered already by an \exe{nm} program and the
   \exe{g++filt} program.
\end{description}

\subsubsection*{Notes}

\begin{itemize}
\item
   The output of the program can be used as input to the \exeref{duplicates}
   program. 
\end{itemize}

\subsubsection*{Diagnostics}

Status return values
\\ \verb+   0+: success
\\ \verb+   1+: no files found

\subsubsection*{Examples}

To show the missing templated classes used in the given file:

\begin{verbatim}
   used -ng -tc  ~/aips++/sun4sol_gnu/libdbg/libaips-Measures-test.a

Using [/u/wbrouw/aips++/sun4sol_gnu/libdbg/libaips-Measures-test.a]
Checked 7 undefineds against 2 defineds
# Undefined templated classes
    1: Array<Bool>
   18: Array<Quantum<Double> >
    7: Array<Double>
   14: Quantum<Vector<Double> >
   18: Quantum<Double>
    6: Vector<Double>
6 undefined objects/global functions shown
\end{verbatim}

To check if the modules in libtrial.a have still some undefined references:

\begin{verbatim}
   used /aips++/weekly/sun4sol_egcs/lib/{libtrial,libaips}.a
\end{verbatim}

The counts shown are the number of references to the class or global function
found.

\subsubsection*{See also}

\exeref{mkinst}, Generate template instantiation files from a list.\\
\exeref{unused}, Checks for usage of templates in binary modules (executables
or object modules).\\
\exeref{duplicates}, Checks for duplicate entries in \file{templates} lists
   across the system.

\subsubsection*{Author}

Original: 1997/09/14 by Wim Brouw, ATNF.

% ----------------------------------------------------------------------------

\newpage
\section{UP scripts to change and move code}
\label{UPscripts}
\index{UPscripts@\exe{UPscripts}}
\index{source files!source file management |see{\exe{UPscripts}}}

The \code{UP} scripts' main purpose is to either change occurrences of
certain patterns in the \aipspp\ code (\exeref{UPchange}), or to move code
files from one directory to another, and update all references to the files
(\exeref{UPmove}). A list of files to be processed is generated in all cases
most easily by the \exeref{UPfind} script (possibly with manual editing of
the list). 

\noindent
In addition some general scripts to aid the system adiministration
(\exeref{UPlist}, \exeref{UPreident}, \exeref{UPdup},  
\exeref{UPlock}, \exeref{UPtmpl}, \exeref{UPload}) exist.

\noindent
Information is exchanged between the different scripts by files. These files
are created in the current working directory, and all have the same name, but
different extensions. The name is the code used to bind different calls
together. To change all files that contain the word {\em cat} into {\em dog},
the following sequence would do that (strcat being the code name): \\
Find the list of files containing the word cat:

\begin{verbatim}
UPfind strcat 
Getting info...
Make sure you have a proper mktree built before proceeding...
Specify code tree root to be used [/nfs/aips++/weekly]: 
Specify egrep expression(s) to find files
Examples: /Measures/((MUString)|(MVAngle)|(MVTime)|(RotM)|Q|(Un))
      or: [(][^(]*[*] *[)][ \t]*0
Multi-line expressions will be ORed
Find expression: [^a-zA-Z_0-9]cat[^a-zA-Z_0-9]
Find expression: 
Specify egrep pattern for files to be removed from raw list found.
Example: [/]aipsview[/]
tmplinst files will always be removed
Remove glish files? (y|n) [y]: 
Remove pattern: 
Starting find...
9 files found in strcat.raw
Starting selected removal...
9 files left in strcat.found
\end{verbatim}

\noindent
The files selected, and the lines that were used in the selection, can be
checked by

\begin{verbatim}
UPlist strcat
Getting info...
9 files found in strcat.found
Starting list...
47 lines in strcat.list
\end{verbatim}

\noindent
The change is then made by:

\begin{verbatim}
UPchange strcat
Getting info...
Specify the sed patterns used to change the contents of the files 
in the files in the strcat.found list. 
Example: s#/Measures/MV#/Quanta/MV#g
         s#[.]ac[(][)]##g
         s#at_cc[(]#(#g
         s#\([^a-zA-Z_]\)assert\([^a-zA-Z_]\)#\1assure\2#g
Change pattern: s#\([^a-zA-Z_0-9]\)cat\([^a-zA-Z_0-9]\)#\1dog\2#g
Change pattern: 
Specify the message lines for the RCS log
Example: Moved includes from Quanta to Measures
Text line: Changed the cat into the dog   
Text line: 
9 files will be changed and checked in/out
./atnf/apps/atcafiller/DOatcafiller.cc started
\end{verbatim}
\ldots

\noindent
Information exchange files produced at this stage:

\begin{verbatim}
 strcat.def
 strcat.done
 strcat.error
 strcat.found
 strcat.list
 strcat.raw
 strcat.rcs
 strcat.rmpat
 strcat.sed
 strcat.spat
\end{verbatim}

\noindent
The scripts are written assuming tcsh is available at the computer used, and
can be accessed by {\em /usr/bin/env}. The script may have to be changed
if this is not the case. Also, the \exeref{UPmove} script uses the {\em amv}
command, only available at the master site, and can only be run from there.\\
Note that the example outputs are only indicative, and could be different in
details. 

% ----------------------------------------------------------------------------

\subsection{\exe{UP*}}

General description of the \exe{UP} scripts.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UP*} [\exe{-<switches>}] [\exe{-c}] [\exe{-r}] [\exe{-u}]
	 [\exe{-d}] [\exe{-n}] <type name>}
\end{synopsis}

\subsubsection*{Description}

\noindent
Each script has the {\em <type name>} as an argument. This type name is the
file name (with varying extensions) that binds the different scripts that
have to cooperate together. If no type name is given, the user is prompted for
one, or one that has been used already that day will be used. It is advisable
to always provide a name.\\
Switches can be given either separately, or bunched together.\\
The output of the scripts is given in files with the type name as main name.

\noindent
The type name act as a memory from invocation to invocation. In general once
information is provided for a specific type, that information will not be
asked for again (unless one of the clearing switches is present, or the
communication files are deleted). Most information is script specific, but
some genarl information is saved in the general definition file \exe{.def}.

\subsubsection*{Options}

\noindent
All scripts accept the following switches; while all the scripts actually
changing system information have also a \exe{-t} test switch, which shows
what would have happened had the script run for real.

\begin{description}
\item[\code{\exe{-h}}]
    Give some useage information
\item[\code{\exe{-c}}]
    Clear all defining information files for the \exe{<type name>} invocation
    of the script, and re-ask it.
\item[\code{\exe{-r}}]
    Clear and re-ask only the general definitions for \exe{<type name>}
\item[\code{\exe{-u}}]
    Clear and re-ask only the specific definitions for \exe{<type name>}
\item[\code{\exe{-d}}]
    Debug mode. Some more output could be generated by some scripts. No
    extensive implementation present.
\item[\code{\exe{-n}}]
    Will only generate the information needed to run the script, without
    executing the real code
\item[\code{\exe{-t}}]
    Available for some scripts only. When present will execute (if no
    \exe{-n} present) the real code, but will not change the system. In
    general the actual change is shown in a \exe{.diff} file.
\item[\code{\exe{-Q}}]
    A switch, mainly for internal use, that indicates that the script will
    run quiet, and only notify of errors, and asking questions. No
    informational messages (like examples of input) are given.
\end{description}

\subsubsection*{Examples}

\noindent
Help information:

\begin{verbatim}
UPfind -h 
Usage:   UPfind [-f] [-g] [-c] [-r] [-u] [-d] [-n] <typ>
  Get all files that contain data according to an egrep rule.
  The found files can be used in other UP scripts like UPlist, 
  UPchange etc. The <typ> is an id acting (by virtue of files) 
  as a communication between the different UP scripts.
  All .cc, .h and templates files in the code tree are searched.
Uses:    <typ>.def, <typ>.spat, <typ>.rmpat
Creates: <typ>.raw, <typ>.found
  -g use all .g files rather than the C++ files
  -f use a file pattern to search for files, not their contents
  -c clear all defining information files for this script
  -r clear only the general defining information in .def
  -u clear all but the general defining information in .def
  -d give some debug information (mostly not implemented)
  -n run script only to get defining information, without executing
  -Q run quietly
  -F force acceptance of normally asked for data
  -h this information

The following UP scripts are available:
    UPfind    [-f] [-g]      [-c] [-r] [-u] [-d] [-n] <typ>
    UPlist    [-l]           [-c] [-r] [-u] [-d] [-n] <typ>         
    UPlock    [-a] [-l]      [-c] [-r] [-u] [-d] [-n] <typ>
    UPchange  [-t]           [-c] [-r] [-u] [-d] [-n] <typ>
    UPmove    [-i] [-t]      [-c] [-r] [-u] [-d] [-n] <typ>
    UPload                   [-c] [-r] [-u] [-d] [-n] <typ>
    UPtmpl                   [-c] [-r] [-u] [-d] [-n] <typ>
    UPdup     [-s]           [-c] [-r] [-u] [-d] [-n] <typ>
    UPreident [-a] [-t] [-z] [-c] [-r] [-u] [-d] [-n] <typ>
\end{verbatim}

\noindent
Providing only the information to run (and clear all information first):

\begin{verbatim}
UPfind -nc strcat
Getting info...
Make sure you have a proper mktree built before proceeding...
Specify code tree root to be used [/nfs/aips++/weekly]: 
Specify egrep expression(s) to find files
Examples: /Measures/((MUString)|(MVAngle)|(MVTime)|(RotM)|Q|(Un))
      or: [(][^(]*[*] *[)][ \t]*0
Multi-line expressions will be ORed
Find expression: [^a-zA-Z_0-9]cat[^a-zA-Z_0-9]
Find expression: 
Specify egrep pattern for files to be removed from raw list found.
Example: [/]aipsview[/]
tmplinst files will always be removed
Remove glish files? (y|n) [y]: 
Remove pattern: 
\end{verbatim}

\noindent
Providing only the information to run (and clear general information first,
and re-use other information):

\begin{verbatim}
UPfind -n -r strcat
Getting info...
Make sure you have a proper mktree built before proceeding...
Specify code tree root to be used [/nfs/aips++/weekly]: 
\end{verbatim}

\noindent
Providing only the information to run (and re-use all information):

\begin{verbatim}
UPfind -n strcat
Getting info...
\end{verbatim}

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\subsection{\exe{UPfind}}
\label{UPfind}
\index{UPfind@\exe{UPfind}}
\index{source files |see{\exe{UPfind}}}

Find files in system code tree. File list to be used in action \exe{UP}
scripts.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPfind} [\exe{-g}] [\exe{-f}]
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

The \exe{UPfind} script finds all files in the \aipspp\ code tree (normally
in the {\em .\{h,cc\}} files, but see the {\em -g} flag) that contain the
specified pattern. The files found will be stored in the \code{<type
name>.raw} file. A filter is applied to leave files to be processed in the
\code{<type>.found} file.

\noindent
The information supplied in answer to questions asked will be stored as well,
for the use in subsequent scripts with the same \code{<type>}.

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-g}}]
    Look for files in \file{.g} rather than \file{.h}, \file{.cc} and
    \file{templates} files.
\item[\code{\exe{-f}}]
    Generate the file list from a set of \exe{file} patterns, rather than a
    set of \exe{egrep} patterns. The \exe{file} patterns should be rooted at
    \exe{AIPSROOT/code}. 
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
UPfind -h
Usage:   UPfind [-f] [-g] [-c] [-r] [-u] [-d] [-n] <typ>
  Get all files that contain data according to an egrep rule.
  The found files can be used in other UP scripts like UPlist, 
  UPchange etc. The <typ> is an id acting (by virtue of files) 
  as a communication between the different UP scripts.
  All .cc, .h and templates files in the code tree are searched.
Uses:    <typ>.def, <typ>.spat, <typ>.rmpat
Creates: <typ>.raw, <typ>.found
  -g use all .g files rather than the C++ files
  -f use a file pattern to search for files, not their contents
\end{verbatim}

\noindent
See the general introduction for an extensive example 

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPlist}}
\label{UPlist}
\index{UPlist@\exe{UPlist}}
\index{source files |see{\exe{UPlist}}}

List the content of files found by the \exe{UPfind} command.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPlist} [\exe{-l}]
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPlist} script lists all the files listed in the \exe{<typ>.found}
file. Only those lines are listed that contains the selection pattern from
the UPfind command. The list is given in \exe{<type>.list}. The command can
be used to check the selection of files before actually changing or moving
files, but is also valid in its own right.

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-l}}]
    Provide a line number in the file lists as well.
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
UPlist -h
Usage:   UPlist [-l] [-c] [-r] [-u] [-d] [-n] <typ>
  List all lines that have been found using an egrep rule in
  <typ>.spat. The files are given in <typ>.found.
  In general the pattern and files are listed using UPfind.
Uses:    <typ>.def, <typ>.spat, <typ>.found
Creates: <typ>.list
  -l will give the line numbers in the files
\end{verbatim}

\noindent
Using the find information from the general introduction, we get:

\begin{verbatim}
UPlist
Assuming <typ> as 'strcat'.
Getting info...
9 files found in strcat.found
Starting list...
47 lines in strcat.list

cat strcat.list
1000 ## ./atnf/apps/atcafiller/DOatcafiller.cc
1001 ## ./bima/apps/bimafiller/bimafiller.cc
1002 ## ./nrao/apps/gbtobsparser/GBTObsSymtab.h
1003 ## ./aips/implement/Utilities/test/tString.cc
1004 ## ./aips/implement/Utilities/String.cc
1005 ## ./trial/implement/MeasurementSets/MSConcat.cc
1006 ## ./trial/implement/MeasurementSets/MSFitsInput.cc
1007 ## ./trial/implement/MeasurementSets/FitsIDItoMS.cc
1008 ## ./trial/apps/aipsview/AvString.cc
1000 ::   Vector<String> cat(nCat);
1000 ::   cat(0)="FLAG_CMD";
1000 ::   cat(1)="ORIGINAL"; 
1000 ::   cat(2)="USER"; 
1000 ::   msc_p->flagCategory().rwKeywordSet().define("CATEGORY",cat);
1001 ::   Vector<String>  cat(nCat);
\end{verbatim}
\ldots

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPlock}}
\label{UPlock}
\index{UPlock@\exe{UPlock}}
\index{source files |see{\exe{UPlock}}}

Check and report if files are locked.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPlock} [\exe{-a}] [\exe{-l}] 
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPlock} script lists all the files that are locked in the
master. Listed in \exe{<type>.lock} are either the files in the
\exe{<typ>.found} file that are locked in the \aipspp\ master tree, or
all locked files.
The command can be used to check the status of files before actually changing
or moving files, but is also valid in its own right. If the command is run
from a local installation, it is assumed that the user has an account at the
aoc aips master suitable for ssh ({\em i.e.} if you are able to do
\exe{rao}). If the account name differs from the local name, the
\code{\$AUID} environment variable has to be set with the remote user name
(like for \exe{rao}). 

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-a}}]
    Show all locked files, rather than the selection based on the
    \exe{<type>.found} list
\item[\code{\exe{-l}}]
    Provide the locker and the revision level in addition to the file name.
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
Usage:   UPlock [-a] [-l] [-c] [-r] [-u] [-d] [-n] <typ>
  Test for each locked file if it is in the list of files
  <typ>.found (as created with UPfind), and output the 
  result in the file <typ>.locked.
Uses:    <typ>.def, <typ>.found
Creates: <typ>.locked
  -a display all locked files, rather than a selection based
     on <typ>.found
  -l show the locker and revision number as well
\end{verbatim}

\noindent
Get all locked files and their lockers:

\begin{verbatim}
  UPlock ct -la
  Getting info...
  Finding locked files...
  201 files in ct.locked

  cat ct.locked
  akemball 15.0 ./aips/implement/MeasurementSets.h
  akemball 15.0 ./bima/apps/bimafiller/bimafiller.g
  akemball 15.0 ./bima/apps/bimafiller/bimafiller.help
\end{verbatim}
\ldots

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPchange}}
\label{UPchange}
\index{UPchange@\exe{UPchange}}
\index{source files |see{\exe{UPchange}}}

Change source files in \aipspp\ master, using a list of files, probably
created by \code{UPfind}.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPchange} [\exe{-t}]
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPchange} script changes all the files given in \exe{<type>.found},
using the editor pattern provided. Successful changes are recorded in
\exe{<type>.done}, unsuccesful ones in \exe{<type>.error}. If the \exe{-t}
test switch is given, no real changes are made, but the differences are
recorded in \exe{<type>.diff}.

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-t}}]
    Do only a test run. Files are checked out and changed, but rather than
    checking the changed files in again, the differences created are recorded.
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
UPchange -h
Usage:   UPchange [-t] [-c] [-r] [-u] [-d] [-n] <typ>
  Update all files given in the <typ>.found list (which is
  normally created by UPfind). Updating means that files
  will be checked out, changed and checked in again.
  <typ>.done and <typ>.error will contain the files successfully
  done or not.
Uses:    <typ>.def, <typ>.found, <typ>.sed, <typ>.rcs
Creates: <typ>.done, <typ>.error, <typ>.diff
  -t will run a test mode, where files are checked out,
     changed, but not checked in again. A file <type>.diff will
     be created showing what would have been changed.
\end{verbatim}

\noindent
See the general introduction for an extensive example 

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPmove}}
\label{UPmove}
\index{UPmove@\exe{UPmove}}
\index{source files |see{\exe{UPmove}}}

Move source files in \aipspp\ master, using a list of files, probably
created by \code{UPfind}. The files will be moved from one path to another,
updating all files referencing these files as well.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPmove} [\exe{-i}] [\exe{-t}]
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPmove} moves files in the \aipspp\ code tree from one place (and/or 
name) to another. At the same time it will change all references to that file
in the system as well. The output of the script is a list of files that were
successfully changed in \exe{<type>.done}, and in \exe{<type>.error} for
unsuccessful ones. If the \exe{-t} test switch is given, the
\exe{<type>.diff} will give differences that would have been made when the
file is run for real.\\
If files are actually moved, the script must be run from the aoc master,
since \code{amv} is involved (see \exeref{UPload} for an easy way).

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-t}}]
    Do only a test run. Files are checked out and changed, but rather than
    checking the changed files in again, the differences created are recorded.
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
UPmove -h
Usage:   UPmove [-t] [-c] [-r] [-u] [-d] [-n] <typ>
  Move files, and change references to them in all aips++
  code files. The script uses the UPfind and UPchange 
  scripts (see there for details).
  <typ>.done and <typ>.error will contain the files successfully
  done or not.
Uses:    <typ>.def, <typ>.sel <typ>.cfnm, <typ>.todo
         <typ>_MVF.found, <typ>_MVF.spat, <typ>_MVF.rmpat
         <typ>_MV.sed, <typ>_MV.rcs, <typ>_MV.found
Creates: <typ>.done, <typ>.error, <typ>.diff
  -t will run a test mode
\end{verbatim}

\noindent
The next example is the start of a move of some files. The script is first
run to get the information (and be able to edit it if necessary).

\begin{verbatim}
UPmove -nc spec
Getting info...
Make sure you have a proper mktree built before proceeding...
Specify code tree root to be used [/nfs/aips++/weekly]: /nfs/aips++/daily
Getting info...
Specify file pattern(s) rooted in AIPSROOT/code to find files
Example: trial/implement/Measures/M*.h
File pattern: trial/implement/Wnbt/Spectral*
File pattern: trial/implement/Wnbt/test/tSpec*
File pattern: 
Specify egrep pattern for files to be removed from raw list found.
Example: [/]aipsview[/]
tmplinst files will always be removed
Remove glish files? (y|n) [y]: 
Remove pattern: 
Starting find...
16 files found in spec_MVF.raw
Starting selected removal...
16 files left in spec_MVF.found
16 files in spec.sel to be moved
Specify the sed patterns used to change the name of the moved files
Example: s#trial/#aips/#
Change pattern: s#/Wnbt#/SpectralComponents#
Change pattern: 
Getting info...
Getting info...
Specify the message lines for the RCS log
Example: Moved includes from Quanta to Measures
Text line: Moved the Spectral fitting files from Wnbt to SpectralComponents
Text line: 
Starting find...
16 files found in spec_MV.raw
Starting selected removal...
16 files left in spec_MV.found
Getting info...
\end{verbatim}

\noindent
The \exe{UPlist} program can be used to check the files that will be changed
(note that you can give the base type name, but that manually editing has to
be done on the \code{spec\_MV.found}):

\begin{verbatim}
UPlist spec
Getting info...
16 files found in spec.found
Starting list...
45 lines in spec.list
\end{verbatim}

\noindent
We now have a dry run with the \exe{-t} test option:

\begin{verbatim}
UPmove -t spec
Getting info...
Need to move files first to new directory (y|n) [n]? y
16 files in spec.sel to be moved
16 files in spec.todo to be changed
amv -src ./trial/implement/Wnbt/Spectral2Element.cc
		./trial/implement/SpectralComponents/Spectral2Element.cc
amv -src ./trial/implement/Wnbt/Spectral2Estimate.cc
		./trial/implement/SpectralComponents/Spectral2Estimate.cc
...
Getting info...
16 files will be changed and checked in/out
Note: in test mode -- no actual file check in after change
./trial/implement/Images/DOimage2.cc started
/aips++/weekly/master/trial/implement/Images/DOimage2.cc,v  -->  DOimage2.cc
revision 15.18
done
...
16 files in spec_MV.done
0 files in spec_MV.error
\end{verbatim}

Checking everything looks ok. We can now transfer all the files to aoc:

\begin{verbatim}
UPload spec
\end{verbatim}

\noindent
and do the actual move (while logged in to \aipspp\ master):

\begin{verbatim}
UPmove spec
Getting info...
Make sure you have a proper mktree built before proceeding...
Specify code tree root to be used [/aips++/weekly]: /aips++/daily
Need to move files first to new directory (y|n) [n]? y
16 files in spec.sel to be moved
16 files in spec.todo to be changed

The rename command for ax_master is as follows:

15 304 src mv ./trial/implement/Wnbt/Spectral2Element.cc
	./trial/implement/SpectralComponents/Spectral2Element.cc

Continue (y/n) [n]:
 /aips++/weekly/master/install/codemgmt/ax_master,v  --> ax_master 
revision 15.525 (locked)
done
/aips++/weekly/master/install/codemgmt/ax_master,v  <--  ax_master
new revision: 15.526; previous revision: 15.525
done
Renamed master RCS version file
   from /aips++/weekly/master/./trial/implement/Wnbt/Spectral2Element.cc,v
     to
/aips++/weekly/master/./trial/implement/SpectralComponents/Spectral2Element.cc,v
...
./trial/implement/SpectralComponents/SpectralList2.cc started
/aips++/weekly/master/trial/implement/SpectralComponents/SpectralList2.cc,v
 	--> SpectralList2.cc
revision 15.1 (locked)
done
/aips++/weekly/master/trial/implement/SpectralComponents/SpectralList2.cc,v
	 <-- SpectralList2.cc
new revision: 15.2; previous revision: 15.1
done
16 files in spec_MV.done
0 files in spec_MV.error
\end{verbatim}

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPload}}
\label{UPload}
\index{UPload@\exe{UPload}}
\index{source files |see{\exe{UPload}}}

Upload the data for the specified type name to the \aipspp\ master computer.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPload} 
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPload} script uploads all relevant information from the given type
name identifier to the aoc \aipspp\ master (or another machine that can
access the master tree with \code{amv}).\\
After transferring the information, login to the master, and run the relevant
script(s) (like \exe{UPlock}, \exe{UPmove}).

\subsubsection*{Options}

\subsubsection*{Examples}

\begin{verbatim}
UPload -h
Usage:   UPload [-c] [-r] [-u] [-d] [-n] <typ>
  Upload the information specified by <typ> to the aips++ 
  master site. This enables to run relevant scripts that
  were tested locally there.
Uses:    <typ>.*
Creates: <typ>.scp
\end{verbatim}

\noindent
Using the information from the \exe{UPmove} example, we get:

\begin{verbatim}
UPload spec
Getting info...
19 files in spec.scp
Uploading 19 files to wbrouw@aips2.nrao.edu:aips++/code/install/codemgmt ....
\end{verbatim}

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPtmpl}}
\label{UPtmpl}
\index{UPtmpl@\exe{UPtmpl}}
\index{source files |see{\exe{UPtmpl}}}

Get a list of all files in all \exe{tmplinst} directories.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPtmpl} 
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPtmpl} script lists all the files in all the \code{tmplst}
directories in the \aipspp\ code tree. The result is available in the
\exe{<type>.tmpinst} file.

\subsubsection*{Options}

\subsubsection*{Examples}

\begin{verbatim}
UPtmpl -h
Usage:   UPtmpl [-c] [-r] [-u] [-d] [-n] <typ>
  Get all files in all the tmplinst directories.
  The file list will be in <typ>.tmpinst
Uses:    <typ>.def
Creates: <typ>.tmpinst
\end{verbatim}

\noindent
A real run gives:

\begin{verbatim}
UPtmpl xc
Getting info...
Make sure you have a proper mktree built before proceeding...
Specify code tree root to be used [/nfs/aips++/weekly]: 
Getting templated file list...
1729 files found in xc.tmpinst
\end{verbatim}

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPdup}}
\label{UPdup}
\index{UPdup@\exe{UPdup}}
\index{source files |see{\exe{UPdup}}}

Do a duplicates template test on templates files in the \aipspp\ code tree.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPdup} [\exe{-s}]
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPdup} script executes the \exe{duplicates} program on templates
files in the \aipspp\ system. It checks the repositories in the casa
packages against each other; checks the repositories and test
templates for the casa packages, and it checks all other packages
against the standard \exe{casa} packages, creating a list with
duplicates in the \exe{<type>.dup} file.
This output can be used to check if templates can
e.g. safely be moved from some local test or application templates file to
one of the standard \exe{casa} packages. An \exe{-s} switch is
available to run in {\em system} mode, which will only indicate duplicates
that in general could produce compilation and/or linking problems. \\

The package handling is done with the aid of in-built lists of
'standard' packages (\exe{casapack}), packages that should be
skipped (\exe{skippack}) and packages that should each be checked
against the standard \exe{casa} packages (\exe{checkpack}). The
defaults can be overwritten by specifying one or more of these 3
variables in the  \exe{<type>.pak} file. After each run the used
variables are saved in the \exe{<type>.pak} file. A template can
easily be derived by running with the \exe{-n} switch.

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-s}}]
    Execute in {\em system} mode. I.e. only show duplicates that are a
    real problem.
\item[\code{\exe{<type>.pak}}]
    If the \exe{<type>.pak} file is present in the directory from which
    the \exe{UPdup} script is run, the checking behaviour can be
    influenced. Each line in the file contains a series of package names. The
    name follwing a '//' field gives the name of the variable to be
    overwritten, the rest are package names. I.e. if
    \exe{<type>.pak} contains a line:
\begin{verbatim}
  // checkpack atnf trialdisplay
\end{verbatim}
    then the duplicates check for the \code{atnf} and
    \code{trialdisplay} packages only will be done against the casa
    base packages.
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
UPdup -h
Usage:   UPdup [-s] [-c] [-r] [-u] [-d] [-n] <typ>
  Determine the template duplicates between the package and
  application/test programs. The result will be in <typ>.dup.
Uses:    <typ>.def   <typ>.pak
Creates: <typ>.dup   <type.pak
  -s show only the system template files that can cause
     problems in the aips++ system

  UPdup -s -u
  Assuming <typ> as 'xc'.
  Getting info...
  Starting package display...
  ...
\end{verbatim}
\ldots

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPreident}}
\label{UPreident}
\index{UPreident@\exe{UPreident}}
\index{source files |see{\exe{UPreident}}}

Do a reident on templates files in the \aipspp\ code tree.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPreident} [\exe{-a}] [\exe{-z}] [\exe{-t}]
	 [\exe{-c}] [\exe{-r}] [\exe{-u}] [\exe{-d}] [\exe{-n}] <type>}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPreident} script executes the \exe{reident} program on templates
files in the \aipspp\ system. By default it runs on the \code{casa}
and other base library packages. Switches are available to execute
it for all packages,
and also to re-initialize the numbering. A list of succesful and unsuccessful
files handled will be available in \exe{<type>.done} and \exe{<type>.error}.

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-a}}]
    Execute for all packages, rather than only for the \code{casa} base ones.
\item[\code{\exe{-z}}]
    Apply the \code{-z} switch, i.e. renumber all templates
\item[\code{\exe{-t}}]
    Do only a test run. Files are checked out and changed, but rather than
    checking the changed files in again, the differences created are recorded
    in \exe{<type>.diff}.
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
UPreident -h
Usage:   UPreident [-a] [-t] [-z] [-c] [-r] [-u] [-d] [-n] <typ>
  Do a reident for all the templates files in the casa basic library
  packages (unless -a switch).
  <typ>.done and <typ>.error will give the templates files
  done and not done.
Uses:    <typ>.def, <typ>.tsel
Creates: <typ>.done, <typ>.error, <typ>/log, <typ>.diff
  -a do all templates files in all packages
  -z use the -z switch on the reident program to renumber 
     all the templates files.
  -t do a dry run, giving the differences in <type>.diff

  UPreident -tu
  Specify type [xc]: 
  Getting info...
  42 templates files found in xc.tsel
  42 files will be changed and checked in/out
  Note: in test mode -- no actual file check in after change
  ./calibration/implement/CalTables/test/templates started
  U templates
  ./calibration/implement/_ReposFiller/templates started
  ...
\end{verbatim}
\ldots

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPsed}}
\label{UPsed}
\index{UPsed@\exe{UPsed}}
\index{source files |see{\exe{UPsed}}}

Apply a \exe{sed} pattern to a file. This script is used  by the other, main,
\exe{UP} scripts. It may be used stand-alone however.

\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{UPsed} [\exe{-t <log>}]
	  \exe{sed} \exe{<filename in>} [\exe{<filename out>}]}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPsed} script applies a number of sed patterns given in the
\exe{sed} file to an input file, and returns the changed input in the output
file. The output file may be the same as the input file (if no output file
given, the output file is assumed to be the same as the input file).\\
If a \exe{log} file name is given as the first argument (preceded by a
\exe{-t} switch), the differences between the input and output file are added
to the \exe{log} file.

\subsubsection*{Options}

\begin{description}
\item[\code{\exe{-t <log file>}}]
    Add the differences between input and output file to an existing log file
\end{description}

\subsubsection*{Examples}

\begin{verbatim}
UPsed
Usage: UPsed [-t <log>] <sed> <filename in> [<filename out>]
\end{verbatim}

\noindent
Change a cat into a dog:

\begin{verbatim}
  cat - > ! c.tmp
  I am a cat today
  cat - >! c.sed
  s#cat#dog#
  UPsed c.sed c.tmp
  cat c.tmp
  I am a dog today
  \end{verbatim}

\begin{verbatim}
  cat - > ! c.tmp
  I am a cat today
  cat - >! c.sed
  s#cat#dog#
  touch c.log
  UPsed -t c.log c.sed c.tmp
  cat c.log
  1c1
  < I am a cat today
  ---
  > I am a dog today
\end{verbatim}

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------

\newpage

\subsection{\exe{UPinfo}}
\label{UPinfo}
\index{UPinfo@\exe{UPinfo}}
\index{source files |see{\exe{UPinfo}}}

Obtain general information for the \exe{UP} scripts. This script is a support
script for the other \exe{UP} scripts.


\subsubsection*{Synopsis}

\begin{synopsis}
   \code{\exe{source UPinfo}}
\end{synopsis}

\subsubsection*{Description}

\noindent
The \exe{UPinfo} {\em source} script is a general aid script for the other,
executable \exe{UP} scripts. It analyses the switches given on the script
command lines (and translates them into switches), and makes sure that the
general information necessary to run the other scripts is available.

\subsubsection*{Options}

\subsubsection*{Examples}

\begin{verbatim}
  UPinfo
  Usage:source UPinfo
  source UPinfo
  script: Undefined variable.
\end{verbatim}

\subsubsection*{Author}

Original: 2000/09/20 by Wim Brouw, ATNF

% ----------------------------------------------------------------------------
